<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Cardápio</title> 
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        /* --- Configurações Globais --- */
        :root {
            --color-primary: #b95c21;
            --color-secondary: #007bff;
            --color-danger: #d9534f;
            --color-warning: #f5a623;
            --color-success: #28a745;
            --color-text-dark: #333;
            --color-text-light: #555;
            --color-text-header: #777;
            --color-text-timestamp: #888;
            --color-border: #e9e9e9;
            --color-bg-page: #ffffff;
            --color-bg-light: #f9f9f9;
            --color-card-title-bg: rgba(255, 255, 255, 0.6);
            --color-card-price-bg: #8c4a28;
            --color-bg-table-header: #f1f1f1;
            --color-success-bg: #e9f7ec;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--color-bg-page);
            color: var(--color-text-dark);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* --- Header (Barra Laranja) --- */
        .top-bar {
            background-color: var(--color-primary);
            color: white;
            padding: 10px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-info .user-avatar { font-size: 36px; opacity: 0.9; }
        .user-info div { display: flex; flex-direction: column; font-size: 14px; }
        .user-info .user-name { font-weight: 600; }
        .user-info .user-role { font-size: 12px; opacity: 0.8; }
        
        /* --- HEADER NAV --- */
        .header-nav { 
            display: flex; 
            align-items: center; 
        }
        .header-nav a {
            color: white;
            text-decoration: none;
            opacity: 0.8; 
            padding: 10px 15px;
            border-radius: 6px; 
            transition: opacity 0.2s, background-color 0.2s;
        }
        .header-nav a:hover {
            opacity: 1; 
            background-color: rgba(255, 255, 255, 0.1);
        }
        .header-nav i { 
            font-size: 20px; 
            cursor: pointer; 
            display: block; 
        }

        /* --- Layout Principal --- */
        .page-container {
            max-width: 1100px;
            width: 95%;
            margin: 32px auto;
            padding: 24px;
            flex-grow: 1;
        }
        .page-header {
            position: relative;
            text-align: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
        }
        .page-header h2 {
            font-size: 20px;
            font-weight: 400;
            color: var(--color-text-header);
            letter-spacing: 0.5px;
            display: inline-block;
            padding-bottom: 8px;
            border-bottom: 1px solid #ccc;
        }
        .page-header .timestamp {
            position: absolute;
            top: 0;
            right: 0;
            font-size: 16px;
            color: var(--color-text-light);
            font-weight: 500;
        }
        .section-title { font-size: 18px; font-weight: 500; color: var(--color-text-header); margin-bottom: 16px; border-bottom: 1px solid var(--color-border); padding-bottom: 8px; }
        
        /* --- Controles (Busca e Filtros) --- */
        .controls-container { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; margin-bottom: 32px; border-bottom: 1px solid var(--color-border); padding-bottom: 16px; }
        .search-container { flex-grow: 1; min-width: 250px; }
        .search-input { padding: 10px 15px; border: 1px solid var(--color-border); border-radius: 6px; font-size: 16px; width: 100%; max-width: 350px; }
        .filter-container { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .filter-btn { background: none; border: 1px solid var(--color-border); border-radius: 6px; padding: 8px 14px; font-size: 14px; cursor: pointer; transition: background-color 0.2s, color 0.2s, border-color 0.2s; color: var(--color-text-light); }
        .filter-btn.active, .filter-btn:hover { background-color: var(--color-primary); color: white; border-color: var(--color-primary); }
        .filter-btn i { margin-right: 5px; }

        /* --- Grade de Itens --- */
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 24px; }
        .menu-item-card { border: 1px solid var(--color-border); border-radius: 8px; overflow: hidden; position: relative; background-color: var(--color-bg-light); min-height: 250px; display: flex; flex-direction: column; justify-content: flex-end; transition: box-shadow 0.2s; }
        .menu-item-card:hover { box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .item-image { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -65%); max-width: 70%; max-height: 55%; object-fit: contain; z-index: 1; }
        .item-info-bg { position: absolute; top: 0; left: -10%; width: 120%; height: 90px; background-color: var(--color-card-title-bg); transform: skewY(-5deg); transform-origin: top left; z-index: 2; }
        .item-details { position: absolute; top: 15px; left: 15px; right: 15px; z-index: 3; }
        .item-title { font-size: 20px; font-weight: bold; color: #d9534f; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); margin-bottom: 4px; }
        .item-units { position: absolute; top: 10px; right: 10px; font-size: 13px; font-weight: 600; color: var(--color-text-dark); background-color: rgba(255,255,255,0.4); padding: 2px 6px; border-radius: 4px; }
        .item-price-bg { position: relative; width: 100%; height: 65px; background-color: var(--color-card-price-bg); clip-path: polygon(0 15%, 100% 0, 100% 100%, 0% 100%); margin-top: -15px; display: flex; align-items: center; justify-content: center; z-index: 3; }
        .item-price { color: white; font-size: 24px; font-weight: bold; }
        
        /* Card de Adicionar */
        .add-item-card { display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; background-color: #e9ecef; border-style: dashed; min-height: 250px; }
        .add-item-card .plus-icon { font-size: 48px; color: var(--color-text-light); margin-bottom: 8px; }
        .add-item-card .add-text { font-size: 18px; font-weight: 600; color: var(--color-text-dark); }
        .add-item-card .item-price-bg { clip-path: none; margin-top: 20px; justify-content: center; background-color: #adb5bd; }
        .add-item-card .item-price { font-size: 24px; color: white; font-weight: bold; }

        /* Ações de Edição/Exclusão */
        .item-actions { position: absolute; top: 10px; left: 10px; z-index: 4; display: flex; gap: 8px; opacity: 0; transition: opacity 0.2s ease-in-out; }
        .menu-item-card:hover .item-actions { opacity: 1; }
        .action-btn { background-color: rgba(0, 0, 0, 0.6); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .action-btn.edit:hover { background-color: var(--color-secondary); }
        .action-btn.delete:hover { background-color: var(--color-danger); }
        .no-results-message { padding: 20px; text-align: center; color: var(--color-text-light); font-style: italic; }

        /* --- Modal --- */
        .modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s ease-in-out; }
        .modal-overlay.active { display: flex; opacity: 1; }
        .modal-content { background-color: #fff; padding: 24px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); width: 90%; max-width: 500px; position: relative; transform: scale(0.95); transition: transform 0.2s ease-in-out; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-close { position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; color: #aaa; cursor: pointer; }
        .modal-close:hover { color: #333; }
        .modal-content h3 { margin-top: 0; margin-bottom: 20px; font-size: 20px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid var(--color-border); border-radius: 6px; font-size: 16px; margin-bottom: 5px; font-family: inherit; }
        .form-group textarea { min-height: 80px; resize: vertical; }
        
        .btn-base { border: none; padding: 10px 16px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        .btn-primary { background-color: var(--color-primary); color: white; }
        .btn-primary:hover { background-color: #9d4d1c; }
        .btn-primary:disabled { background-color: #aaa; cursor: not-allowed; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-danger { background-color: var(--color-danger); color: white; }
        .btn-danger:hover { background-color: #c82333; }
        
        #alert-modal-message, #confirm-modal-message { font-size: 16px; line-height: 1.6; margin-bottom: 24px; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }

        /* --- Responsividade --- */
        @media (max-width: 768px) {
            .top-bar { flex-direction: column; gap: 16px; padding: 16px; }
            .header-nav { gap: 20px; flex-wrap: wrap; justify-content: center; }
            .page-header { text-align: left; display: flex; flex-direction: column; align-items: flex-start; gap: 8px; }
            .page-header h2 { font-size: 18px; }
            .page-header .timestamp { position: static; font-size: 14px; }
            .page-container { margin-top: 24px; padding: 16px; }
            .controls-container { flex-direction: column; align-items: stretch; }
            .search-input { max-width: none; }
            .filter-container { justify-content: center; }
            .menu-grid { grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 16px; }
            .item-title { font-size: 18px; }
            .item-price { font-size: 20px; }
        }
    </style>
</head>
<body>

    <header class="top-bar">
        <div class="user-info">
            <i class="fa-solid fa-user-circle user-avatar"></i>
            <div>
                <span class="user-name">Felipe</span>
                <span class="user-role">administração da plataforma</span>
            </div>
        </div>
        <nav class="header-nav">
            <a href="Adm_status.html"><i class="fa-solid fa-list-check" title="Status"></i></a>
            <a href="Adm_Ped.html"><i class="fa-solid fa-truck" title="Entregas"></i></a>
            <a href="Adm_anal.html"><i class="fa-solid fa-chart-line" title="Vendas"></i></a>
            <a href="Adam_estoq.html"><i class="fa-solid fa-box" title="Estoque"></i></a>
            <a href="Adm_agen.html"><i class="fa-solid fa-calendar-days" title="Agenda"></i></a>
            <a href="Adm_Func.html"><i class="fa-solid fa-user" title="Funcionários"></i></a>
            <a href="adm_adCard.html"><i class="fa-solid fa-utensils" title="Cardápio"></i></a>
            <a href="SalgaderiaMestreLogOn.html"><i class="fa-solid fa-arrow-right-from-bracket" title="Sair"></i></a>
        </nav>
    </header>

    <main class="page-container">

        <header class="page-header">
            <h2>GERENCIAR CARDÁPIO</h2>
            <span class="timestamp" id="current-timestamp"></span>
        </header>

        <section class="controls-container">
            <div class="search-container">
                <input type="text" id="search-input" class="search-input" placeholder="Buscar item no cardápio...">
            </div>
            <div class="filter-container">
                <button class="filter-btn active" data-filter="all">Todos</button>
                <button class="filter-btn" data-filter="Fritos">Fritos</button>
                <button class="filter-btn" data-filter="Mini Salgados">Mini Salgados</button>
                <button class="filter-btn" data-filter="Assados">Assados</button>
                <button class="filter-btn" data-filter="Bebidas">Bebidas</button>
                <button class="filter-btn" data-filter="Doces">Doces</button>
                <button class="filter-btn" data-filter="Combos">Combos</button>
            </div>
        </section>

        <section class="menu-grid" id="menu-grid">
            <div class="menu-item-card add-item-card" id="add-item-btn">
                 <i class="fa-solid fa-plus plus-icon"></i>
                 <span class="add-text">Adicionar item</span>
                 <div class="item-price-bg">
                    <span class="item-price">R$</span>
                 </div>
            </div>
        </section>

    </main>

    <div class="modal-overlay" id="item-modal">
        <div class="modal-content">
            <span class="modal-close" data-modal-id="item-modal">&times;</span>
            <h3 id="modal-title">Adicionar Novo Item</h3>
            <form id="item-form">
                <input type="hidden" id="item-id">
                <div class="form-group">
                    <label for="item-name">Nome do Item</label>
                    <input type="text" id="item-name" required>
                </div>
                 <div class="form-group">
                    <label for="item-category">Categoria</label>
                    <select id="item-category" required>
                        <option value="">Selecione...</option>
                        <option value="Fritos">Fritos</option>
                        <option value="Mini Salgados">Mini Salgados</option>
                        <option value="Assados">Assados</option>
                        <option value="Bebidas">Bebidas</option>
                        <option value="Doces">Doces</option>
                        <option value="Combos">Combos</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="item-price">Preço (R$)</label>
                    <input type="number" step="0.01" id="item-price" required placeholder="Ex: 14.99">
                </div>
                 <div class="form-group">
                    <label for="item-units">Unidades (texto)</label>
                    <input type="text" id="item-units" required placeholder="Ex: 1 UNID., 25 UNID.">
                </div>
                <div class="form-group">
                     <label for="item-image-path">Caminho da Imagem</label>
                     <input type="text" id="item-image-path" placeholder="Ex: imagens_cardapio/coxinha.png">
                     <small>Adicione a imagem na pasta do projeto e dê 'git push' primeiro.</small>
                </div>
                
                <div class="form-group">
                     <label for="item-description">Descrição</label>
                     <textarea id="item-description" placeholder="Descreva o produto..."></textarea>
                </div>
                <div class="form-group">
                     <label for="item-nutrition">Informação Nutricional</label>
                     <textarea id="item-nutrition" placeholder="Ex: CALORIAS: 180 KCAL, PROTEÍNAS: 5 G..."></textarea>
                     <small>Dica: Separe os itens com vírgula ou quebra de linha.</small>
                </div>

                <button type="submit" class="btn-primary" id="save-item-btn">Salvar Item</button>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="alert-modal">
        <div class="modal-content">
            <h3 id="alert-modal-title">Aviso</h3>
            <p id="alert-modal-message">Mensagem de alerta aqui.</p>
            <div class="modal-footer">
                <button class="btn-base btn-primary" id="alert-modal-ok">OK</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="confirm-modal">
        <div class="modal-content">
            <h3 id="confirm-modal-title">Confirmar Ação</h3>
            <p id="confirm-modal-message">Tem certeza?</p>
            <div class="modal-footer">
                <button class="btn-base btn-secondary" id="confirm-modal-cancel">Cancelar</button>
                <button class="btn-base btn-danger" id="confirm-modal-ok">Confirmar</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- 1. IMPORTS DO FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { 
            getFirestore, collection, getDocs, doc, getDoc, 
            addDoc, updateDoc, deleteDoc, query, orderBy, serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
        
        // --- 2. CONFIGURAÇÃO DO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCn694_Aswhv1Fb2dn7pnWox4JVW66Xy2k",
            authDomain: "salgaderia-mestre.firebaseapp.com",
            projectId: "salgaderia-mestre",
            storageBucket: "salgaderia-mestre.firebasestorage.app",
            messagingSenderId: "280285587483",
            appId: "1:280285587483:web:0b36fab366f2e0f2b8b0be",
            measurementId: "G-1QSMWQ65ZZ"
        };

        // --- 3. INICIALIZAÇÃO ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const produtosCollectionRef = collection(db, "produtos");
        const logsCollectionRef = collection(db, "logs");

        // --- 4. SELETORES DO DOM ---
        const timestampElement = document.getElementById('current-timestamp');
        const menuGrid = document.getElementById('menu-grid');
        const searchInput = document.getElementById('search-input');
        const filterButtons = document.querySelectorAll('.filter-btn');
        const addItemBtnCard = document.getElementById('add-item-btn');
        
        // Modais de Formulário
        const itemModal = document.getElementById('item-modal');
        const itemForm = document.getElementById('item-form');
        const modalTitle = document.getElementById('modal-title');
        const itemIdInput = document.getElementById('item-id');
        const itemNameInput = document.getElementById('item-name');
        const itemCategoryInput = document.getElementById('item-category');
        const itemPriceInput = document.getElementById('item-price');
        const itemUnitsInput = document.getElementById('item-units');
        const itemImagePathInput = document.getElementById('item-image-path');
        const itemDescriptionInput = document.getElementById('item-description');
        const itemNutritionInput = document.getElementById('item-nutrition');
        const modalCloseButtons = document.querySelectorAll('.modal-close');

        // Modais de Alerta/Confirmação
        const alertModal = document.getElementById('alert-modal');
        const alertModalOkBtn = document.getElementById('alert-modal-ok');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalCancelBtn = document.getElementById('confirm-modal-cancel');
        let confirmModalOkBtn = document.getElementById('confirm-modal-ok');

        let localMenuItems = [];

        // --- 5. ATUALIZAÇÃO DO TIMESTAMP ---
        function updateCurrentTime() {
            const now = new Date();
            const optionsDate = { day: '2-digit', month: '2-digit', year: '2-digit' };
            const optionsTime = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
            const date = now.toLocaleDateString('pt-BR', optionsDate);
            const time = now.toLocaleTimeString('pt-BR', optionsTime);
            if (timestampElement) { timestampElement.textContent = `${date} ${time}`; }
        }
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);

        // --- 6. FUNÇÕES DE MODAL (ALERTAS) ---
        function showCustomAlert(message, title = "Aviso") {
            document.getElementById('alert-modal-title').textContent = title;
            document.getElementById('alert-modal-message').textContent = message;
            alertModal.classList.add('active');
        }
        
        function showCustomConfirm(message, title, onConfirm) {
            document.getElementById('confirm-modal-title').textContent = title;
            document.getElementById('confirm-modal-message').textContent = message;
            confirmModal.classList.add('active');
            
            let newOkBtn = confirmModalOkBtn.cloneNode(true);
            confirmModalOkBtn.parentNode.replaceChild(newOkBtn, confirmModalOkBtn);
            confirmModalOkBtn = newOkBtn; 
            
            newOkBtn.addEventListener('click', () => {
                onConfirm(); 
                confirmModal.classList.remove('active');
            });
        }
        
        alertModalOkBtn.addEventListener('click', () => alertModal.classList.remove('active'));
        confirmModalCancelBtn.addEventListener('click', () => confirmModal.classList.remove('active'));

        // --- 7. FUNÇÃO DE LOG ---
        async function logAdminAction(level, system, message) {
            try {
                await addDoc(logsCollectionRef, {
                    level: level,
                    system: system,
                    message: message,
                    timestamp: serverTimestamp()
                });
            } catch (e) {
                console.error("Falha ao salvar log: ", e);
            }
        }

        // --- 8. FUNÇÃO PARA RENDERIZAR A GRADE ---
        function renderMenuGrid(itemsToRender) {
            const existingItems = menuGrid.querySelectorAll('.menu-item-card:not(.add-item-card)');
            existingItems.forEach(item => item.remove());
            const noResultsMsg = menuGrid.querySelector('.no-results-message');
            if (noResultsMsg) noResultsMsg.remove();

            if (itemsToRender.length === 0 && !searchInput.value && document.querySelector('.filter-btn.active[data-filter="all"]')) {
                // Não mostra mensagem se não há itens mas também não há filtro/busca ativa
            } else if (itemsToRender.length === 0) {
                 const noResults = document.createElement('p');
                 noResults.className = 'no-results-message';
                 noResults.textContent = 'Nenhum item encontrado.';
                 noResults.style.gridColumn = '1 / -1';
                 noResults.style.textAlign = 'center';
                 noResults.style.color = 'var(--color-text-light)';
                 menuGrid.appendChild(noResults);
            }

            itemsToRender.forEach(item => {
                const card = document.createElement('div');
                card.className = 'menu-item-card';
                card.setAttribute('data-id', item.id);
                card.setAttribute('data-category', item.categoria);

                const placeholder = `https://via.placeholder.com/150/EEEEEE/AAAAAA?text=SemFoto`;
                const imageSrc = item.caminhoImagem || placeholder;

                card.innerHTML = `
                    <img src="${imageSrc}" alt="${item.nome}" class="item-image" onerror="this.onerror=null; this.src='${placeholder}';">
                    <div class="item-info-bg"></div>
                    <div class="item-details">
                        <div class="item-title">${item.nome}</div>
                        <div class="item-units">${item.unidadesTexto}</div>
                    </div>
                    <div class="item-price-bg">
                        <span class="item-price">R$ ${Number(item.preco).toFixed(2).replace('.', ',')}</span>
                    </div>
                    <div class="item-actions">
                        <button class="action-btn edit" title="Editar Item" data-id="${item.id}"><i class="fa-solid fa-pencil"></i></button>
                        <button class="action-btn delete" title="Excluir Item" data-id="${item.id}" data-name="${item.nome}"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `;
                menuGrid.insertBefore(card, addItemBtnCard); 
            });
            
            // Adiciona listeners aos botões
            menuGrid.querySelectorAll('.edit').forEach(btn => {
                btn.addEventListener('click', (e) => openModal('edit', e.currentTarget.dataset.id));
            });
            menuGrid.querySelectorAll('.delete').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    const name = e.currentTarget.dataset.name;
                    showCustomConfirm(`Tem certeza que deseja excluir "${name}"?`, "Confirmar Exclusão", () => {
                        deleteItem(id, name);
                    });
                });
            });
        }
        
        // --- 9. CARREGAMENTO INICIAL DO FIRESTORE ---
        async function loadAndRenderItems() {
            try {
                const q = query(produtosCollectionRef, orderBy("categoria", "asc"), orderBy("nome", "asc"));
                const querySnapshot = await getDocs(q);
                localMenuItems = []; 
                querySnapshot.forEach((doc) => {
                    localMenuItems.push({ id: doc.id, ...doc.data() });
                });
                applyFiltersAndSearch(); 
            } catch (error) {
                console.error("Erro ao carregar itens: ", error);
                if (error.code === 'failed-precondition') {
                    console.warn("Firestore: Índices não encontrados. Carregando sem ordenação.");
                    const fallbackSnapshot = await getDocs(produtosCollectionRef);
                    localMenuItems = [];
                    fallbackSnapshot.forEach((doc) => {
                        localMenuItems.push({ id: doc.id, ...doc.data() });
                    });
                    applyFiltersAndSearch();
                } else {
                    showCustomAlert(`Não foi possível carregar os itens: ${error.message}`, "Erro no Firebase");
                }
            }
        }
        
        // --- 10. LÓGICA DO MODAL (ADICIONAR/EDITAR) ---
        async function openModal(mode = 'add', itemId = null) {
            itemForm.reset();
            itemIdInput.value = '';

            if (mode === 'edit' && itemId !== null) {
                modalTitle.textContent = 'Editar Item';
                try {
                    const docRef = doc(db, "produtos", itemId);
                    const docSnap = await getDoc(docRef);
                    if (!docSnap.exists()) {
                        showCustomAlert("Erro: Item não encontrado.", "Erro");
                        return;
                    }
                    const item = docSnap.data();
                    
                    itemIdInput.value = docSnap.id;
                    itemNameInput.value = item.nome;
                    itemCategoryInput.value = item.categoria;
                    itemPriceInput.value = Number(item.preco).toFixed(2);
                    itemUnitsInput.value = item.unidadesTexto;
                    itemImagePathInput.value = item.caminhoImagem || '';
                    itemDescriptionInput.value = item.descricao || '';
                    itemNutritionInput.value = item.infoNutricional || '';

                } catch (error) {
                    console.error("Erro ao buscar item para edição: ", error);
                    showCustomAlert("Não foi possível carregar os dados do item.", "Erro");
                    return;
                }
            } else {
                modalTitle.textContent = 'Adicionar Novo Item';
            }
            itemModal.classList.add('active');
        }

        function closeModal() { 
            itemModal.classList.remove('active'); 
        }

        // Event listeners para fechar modal
        modalCloseButtons.forEach(btn => {
            if (btn.dataset.modalId) {
                btn.addEventListener('click', () => {
                    const modalId = btn.dataset.modalId;
                    document.getElementById(modalId).classList.remove('active');
                });
            }
        });

        // Adicionar item
        addItemBtnCard.addEventListener('click', () => openModal('add'));

        // Salvar/editar item
        itemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const itemData = {
                nome: itemNameInput.value.trim(),
                categoria: itemCategoryInput.value,
                preco: parseFloat(itemPriceInput.value),
                unidadesTexto: itemUnitsInput.value.trim(),
                caminhoImagem: itemImagePathInput.value.trim() || null,
                descricao: itemDescriptionInput.value.trim() || null,
                infoNutricional: itemNutritionInput.value.trim() || null
            };

            try {
                if (itemIdInput.value) {
                    // Editar item existente
                    const docRef = doc(db, "produtos", itemIdInput.value);
                    await updateDoc(docRef, itemData);
                    showCustomAlert("Item atualizado com sucesso!", "Sucesso");
                    await logAdminAction("INFO", "CARDAPIO", `Item editado: ${itemData.nome}`);
                } else {
                    // Adicionar novo item
                    await addDoc(produtosCollectionRef, itemData);
                    showCustomAlert("Item adicionado com sucesso!", "Sucesso");
                    await logAdminAction("INFO", "CARDAPIO", `Item adicionado: ${itemData.nome}`);
                }
                
                closeModal();
                await loadAndRenderItems();
            } catch (error) {
                console.error("Erro ao salvar item: ", error);
                showCustomAlert(`Falha ao salvar: ${error.message}`, "Erro no Firebase");
            }
        });

        // Excluir item
        async function deleteItem(itemId, itemName) {
            try {
                const docRef = doc(db, "produtos", itemId);
                await deleteDoc(docRef);
                showCustomAlert(`"${itemName}" excluído com sucesso!`, "Sucesso");
                await logAdminAction("WARNING", "CARDAPIO", `Item excluído: ${itemName}`);
                await loadAndRenderItems();
            } catch (error) {
                console.error("Erro ao excluir item: ", error);
                showCustomAlert(`Falha ao excluir: ${error.message}`, "Erro no Firebase");
            }
        }
        
        // --- 11. LÓGICA DE FILTROS E BUSCA ---
        function applyFiltersAndSearch() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const activeFilterBtn = document.querySelector('.filter-btn.active');
            const activeCategory = activeFilterBtn ? activeFilterBtn.dataset.filter : 'all';

            let filteredItems = localMenuItems;

            if (activeCategory !== 'all') {
                filteredItems = filteredItems.filter(item => item.categoria === activeCategory);
            }
            if (searchTerm) {
                filteredItems = filteredItems.filter(item => item.nome.toLowerCase().includes(searchTerm));
            }
            
            renderMenuGrid(filteredItems);
        }
        
        searchInput.addEventListener('input', applyFiltersAndSearch);
        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                filterButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                applyFiltersAndSearch();
            });
        });

        // --- 12. INICIALIZAÇÃO ---
        loadAndRenderItems();

    </script>
</body>
</html>