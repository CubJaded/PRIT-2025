<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Cardápio</title> 
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        /* --- Configurações Globais --- */
        :root {
            --color-primary: #b95c21;
            --color-secondary: #007bff;
            --color-danger: #d9534f;
            --color-warning: #f5a623;
            --color-success: #28a745;
            --color-text-dark: #333;
            --color-text-light: #555;
            --color-text-header: #777;
            --color-text-timestamp: #888;
            --color-border: #e9e9e9;
            --color-bg-page: #ffffff;
            --color-bg-light: #f9f9f9;
            --color-card-title-bg: rgba(255, 255, 255, 0.6);
            --color-card-price-bg: #8c4a28;
            --color-bg-table-header: #f1f1f1;
            --color-success-bg: #e9f7ec;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--color-bg-page);
            color: var(--color-text-dark);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

         /* --- Header (Barra Laranja) --- */
        .top-bar {
            background-color: var(--color-primary);
            color: white;
            padding: 10px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-info .user-avatar { font-size: 36px; opacity: 0.9; }
        .user-info div { display: flex; flex-direction: column; font-size: 14px; }
        .user-info .user-name { font-weight: 600; }
        .user-info .user-role { font-size: 12px; opacity: 0.8; }
        
        /* --- NAVBAR COM ESPAÇAMENTO IGUAL AOS OUTROS CÓDIGOS --- */
        .header-nav { 
            display: flex; 
            align-items: center; 
            gap: 28px; /* MESMO ESPAÇAMENTO DOS OUTROS CÓDIGOS */
        }
        .header-nav a {
            color: white;
            text-decoration: none;
            opacity: 0.8; 
            padding: 10px 15px; /* MESMO ESPAÇAMENTO DOS OUTROS CÓDIGOS */
            border-radius: 6px; 
            transition: opacity 0.2s, background-color 0.2s;
        }
        .header-nav a:hover {
            opacity: 1; 
            background-color: rgba(255, 255, 255, 0.1); 
        }
        .header-nav i { 
            font-size: 20px; 
            cursor: pointer; 
            display: block; 
        }

        /* --- Layout Principal --- */
        .page-container {
            max-width: 1100px;
            width: 95%;
            margin: 32px auto;
            padding: 24px;
            flex-grow: 1;
        }
        .page-header {
            position: relative;
            text-align: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
        }
        .page-header h2 {
            font-size: 20px;
            font-weight: 400;
            color: var(--color-text-header);
            letter-spacing: 0.5px;
            display: inline-block;
            padding-bottom: 8px;
            border-bottom: 1px solid #ccc;
        }
        .page-header .timestamp {
            position: absolute;
            top: 0;
            right: 0;
            font-size: 16px;
            color: var(--color-text-light);
            font-weight: 500;
        }
        .section-title { font-size: 18px; font-weight: 500; color: var(--color-text-header); margin-bottom: 16px; border-bottom: 1px solid var(--color-border); padding-bottom: 8px; }
        
        /* --- Controles (Busca e Filtros) --- */
        .controls-container { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; margin-bottom: 32px; border-bottom: 1px solid var(--color-border); padding-bottom: 16px; }
        .search-container { flex-grow: 1; min-width: 250px; }
        .search-input { padding: 10px 15px; border: 1px solid var(--color-border); border-radius: 6px; font-size: 16px; width: 100%; max-width: 350px; }
        .filter-container { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .filter-btn { background: none; border: 1px solid var(--color-border); border-radius: 6px; padding: 8px 14px; font-size: 14px; cursor: pointer; transition: background-color 0.2s, color 0.2s, border-color 0.2s; color: var(--color-text-light); }
        .filter-btn.active, .filter-btn:hover { background-color: var(--color-primary); color: white; border-color: var(--color-primary); }
        .filter-btn i { margin-right: 5px; }

        /* --- Grade de Itens --- */
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 24px; }
        .menu-item-card { border: 1px solid var(--color-border); border-radius: 8px; overflow: hidden; position: relative; background-color: var(--color-bg-light); min-height: 250px; display: flex; flex-direction: column; justify-content: flex-end; transition: box-shadow 0.2s; }
        .menu-item-card:hover { box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .item-image { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -65%); max-width: 70%; max-height: 55%; object-fit: contain; z-index: 1; }
        .item-info-bg { position: absolute; top: 0; left: -10%; width: 120%; height: 90px; background-color: var(--color-card-title-bg); transform: skewY(-5deg); transform-origin: top left; z-index: 2; }
        .item-details { position: absolute; top: 15px; left: 15px; right: 15px; z-index: 3; }
        .item-title { font-size: 20px; font-weight: bold; color: #d9534f; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); margin-bottom: 4px; }
        .item-units { position: absolute; top: 10px; right: 10px; font-size: 13px; font-weight: 600; color: var(--color-text-dark); background-color: rgba(255,255,255,0.4); padding: 2px 6px; border-radius: 4px; }
        .item-price-bg { position: relative; width: 100%; height: 65px; background-color: var(--color-card-price-bg); clip-path: polygon(0 15%, 100% 0, 100% 100%, 0% 100%); margin-top: -15px; display: flex; align-items: center; justify-content: center; z-index: 3; }
        .item-price { color: white; font-size: 24px; font-weight: bold; }
        
        /* Card de Adicionar */
        .add-item-card { display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; background-color: #e9ecef; border-style: dashed; min-height: 250px; }
        .add-item-card .plus-icon { font-size: 48px; color: var(--color-text-light); margin-bottom: 8px; }
        .add-item-card .add-text { font-size: 18px; font-weight: 600; color: var(--color-text-dark); }
        .add-item-card .item-price-bg { clip-path: none; margin-top: 20px; justify-content: center; background-color: #adb5bd; }
        .add-item-card .item-price { font-size: 24px; color: white; font-weight: bold; }

        /* Ações de Edição/Exclusão */
        .item-actions { position: absolute; top: 10px; left: 10px; z-index: 4; display: flex; gap: 8px; opacity: 0; transition: opacity 0.2s ease-in-out; }
        .menu-item-card:hover .item-actions { opacity: 1; }
        .action-btn { background-color: rgba(0, 0, 0, 0.6); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .action-btn.edit:hover { background-color: var(--color-secondary); }
        .action-btn.delete:hover { background-color: var(--color-danger); }
        .no-results-message { padding: 20px; text-align: center; color: var(--color-text-light); font-style: italic; }

        /* --- Modal --- */
        .modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s ease-in-out; }
        .modal-overlay.active { display: flex; opacity: 1; }
        .modal-content { background-color: #fff; padding: 24px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); width: 90%; max-width: 600px; position: relative; transform: scale(0.95); transition: transform 0.2s ease-in-out; max-height: 90vh; overflow-y: auto; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-close { position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; color: #aaa; cursor: pointer; }
        .modal-close:hover { color: #333; }
        .modal-content h3 { margin-top: 0; margin-bottom: 20px; font-size: 20px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid var(--color-border); border-radius: 6px; font-size: 16px; margin-bottom: 5px; font-family: inherit; }
        .form-group textarea { min-height: 80px; resize: vertical; }
        
        /* Campos de Informação Nutricional */
        .nutrition-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        .nutrition-item {
            display: flex;
            flex-direction: column;
        }
        .nutrition-item input {
            width: 100%;
        }
        
        /* Upload de Imagem */
        .image-upload-container { border: 2px dashed var(--color-border); border-radius: 8px; padding: 20px; text-align: center; margin-bottom: 16px; }
        .image-preview { max-width: 200px; max-height: 200px; margin: 10px auto; display: none; border-radius: 8px; }
        .upload-btn { background: var(--color-secondary); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin: 10px 0; }
        .upload-btn:hover { background: #0056b3; }
        
        .btn-base { border: none; padding: 10px 16px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        .btn-primary { background-color: var(--color-primary); color: white; }
        .btn-primary:hover { background-color: #9d4d1c; }
        .btn-primary:disabled { background-color: #aaa; cursor: not-allowed; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-danger { background-color: var(--color-danger); color: white; }
        .btn-danger:hover { background-color: #c82333; }
        
        #alert-modal-message, #confirm-modal-message { font-size: 16px; line-height: 1.6; margin-bottom: 24px; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }

        .loading { opacity: 0.7; pointer-events: none; }
        .progress-bar { width: 100%; height: 4px; background: #f0f0f0; border-radius: 2px; margin: 10px 0; overflow: hidden; }
        .progress { height: 100%; background: var(--color-primary); width: 0%; transition: width 0.3s; }

        /* --- Responsividade --- */
        @media (max-width: 768px) {
            .top-bar { flex-direction: column; gap: 16px; padding: 16px; }
            .header-nav { gap: 5px; flex-wrap: wrap; justify-content: center; }
            .header-nav a { padding: 8px 12px; font-size: 0.9rem; }
            .page-header { text-align: left; display: flex; flex-direction: column; align-items: flex-start; gap: 8px; }
            .page-header h2 { font-size: 18px; }
            .page-header .timestamp { position: static; font-size: 14px; }
            .page-container { margin-top: 24px; padding: 16px; }
            .controls-container { flex-direction: column; align-items: stretch; }
            .search-input { max-width: none; }
            .filter-container { justify-content: center; }
            .menu-grid { grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 16px; }
            .item-title { font-size: 18px; }
            .item-price { font-size: 20px; }
            .modal-content { width: 95%; padding: 16px; }
            .nutrition-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <header class="top-bar">
        <div class="user-info">
            <i class="fa-solid fa-user-circle user-avatar"></i>
            <div>
                <span class="user-name" id="user-display-name">Felipe</span>
                <span class="user-role">administração da plataforma</span>
            </div>
        </div>
        <nav class="header-nav">
            <a href="Adm_status.html"><i class="fa-solid fa-list-check"></i> </a>
            <a href="Adm_Ped.html"><i class="fa-solid fa-truck"></i> </a>
            <a href="Adm_anal.html"><i class="fa-solid fa-chart-line"></i> </a>
            <a href="Adam_estoq.html"><i class="fa-solid fa-box"></i> </a>
            <a href="Adm_agen.html"><i class="fa-solid fa-calendar-days"></i> </a>
            <a href="Adm_Func.html"><i class="fa-solid fa-user"></i> </a>
            <a href="adm_adCard.html" style="background-color: rgba(255,255,255,0.2);"><i class="fa-solid fa-utensils"></i> </a>
            <a href="SalgaderiaMestreLogOff.html" id="logout-btn"><i class="fa-solid fa-arrow-right-from-bracket"></i> </a>
        </nav>
    </header>

    <main class="page-container">

        <header class="page-header">
            <h2>GERENCIAR CARDÁPIO</h2>
            <span class="timestamp" id="current-timestamp"></span>
        </header>

        <section class="controls-container">
            <div class="search-container">
                <input type="text" id="search-input" class="search-input" placeholder="Buscar item no cardápio...">
            </div>
            <div class="filter-container">
                <button class="filter-btn active" data-filter="all">Todos</button>
                <button class="filter-btn" data-filter="Mini Salgados">Mini Salgados</button>
                <button class="filter-btn" data-filter="Doces">Doces</button>
                <button class="filter-btn" data-filter="Combos">Combos</button>
                <button class="filter-btn" data-filter="Bebidas">Bebidas</button>
                <button class="filter-btn" data-filter="Assados">Assados</button>
                <button class="filter-btn" data-filter="Fritos">Fritos</button>
            </div>
        </section>

        <section class="menu-grid" id="menu-grid">
            <div class="menu-item-card add-item-card" id="add-item-btn">
                 <i class="fa-solid fa-plus plus-icon"></i>
                 <span class="add-text">Adicionar item</span>
                 <div class="item-price-bg">
                    <span class="item-price">R$</span>
                 </div>
            </div>
        </section>

    </main>

    <!-- Modal para Adicionar/Editar Item -->
    <div class="modal-overlay" id="item-modal">
        <div class="modal-content">
            <span class="modal-close" data-modal-id="item-modal">&times;</span>
            <h3 id="modal-title">Adicionar Novo Item</h3>
            <form id="item-form">
                <input type="hidden" id="item-id">
                
                <div class="form-group">
                    <label for="item-name">Nome do Item *</label>
                    <input type="text" id="item-name" required>
                </div>
                
                <div class="form-group">
                    <label for="item-category">Categoria *</label>
                    <select id="item-category" required>
                        <option value="">Selecione...</option>
                        <option value="Mini Salgados">Mini Salgados</option>
                        <option value="Doces">Doces</option>
                        <option value="Combos">Combos</option>
                        <option value="Bebidas">Bebidas</option>
                        <option value="Assados">Assados</option>
                        <option value="Fritos">Fritos</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="item-price">Preço (R$) *</label>
                    <input type="number" step="0.01" id="item-price" required placeholder="Ex: 14.99" min="0">
                </div>
                
                <div class="form-group">
                    <label for="item-units">Unidades (texto) *</label>
                    <input type="text" id="item-units" required placeholder="Ex: 1 UNID., 25 UNID.">
                </div>
                
                <div class="form-group">
                    <label>Imagem do Produto</label>
                    <div class="image-upload-container">
                        <img id="image-preview" class="image-preview" alt="Preview da imagem">
                        <div id="upload-area">
                            <p>Arraste uma imagem aqui ou clique para selecionar</p>
                            <input type="file" id="item-image" accept="image/*" style="display: none;">
                            <button type="button" class="upload-btn" id="select-image-btn">Selecionar Imagem</button>
                        </div>
                        <div class="progress-bar">
                            <div class="progress" id="upload-progress"></div>
                        </div>
                        <small>Formatos: JPG, PNG, GIF. Tamanho máximo: 5MB</small>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="item-description">Descrição</label>
                    <textarea id="item-description" placeholder="Descreva o produto..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>Tabela Nutricional</label>
                    <div class="nutrition-grid">
                        <div class="nutrition-item">
                            <label for="nutrition-calories">Calorias *</label>
                            <input type="text" id="nutrition-calories" required placeholder="Ex: 90 KCAL">
                        </div>
                        <div class="nutrition-item">
                            <label for="nutrition-carbs">Carboidratos *</label>
                            <input type="text" id="nutrition-carbs" required placeholder="Ex: 7 G">
                        </div>
                        <div class="nutrition-item">
                            <label for="nutrition-proteins">Proteínas *</label>
                            <input type="text" id="nutrition-proteins" required placeholder="Ex: 2 G">
                        </div>
                        <div class="nutrition-item">
                            <label for="nutrition-fats">Gorduras *</label>
                            <input type="text" id="nutrition-fats" required placeholder="Ex: 5 G">
                        </div>
                        <div class="nutrition-item">
                            <label for="nutrition-sodium">Sódio *</label>
                            <input type="text" id="nutrition-sodium" required placeholder="Ex: 75 MG">
                        </div>
                        <div class="nutrition-item">
                            <label for="nutrition-sugars">Açúcares *</label>
                            <input type="text" id="nutrition-sugars" required placeholder="Ex: 1 G">
                        </div>
                    </div>
                    <small>* Campos obrigatórios da tabela nutricional</small>
                </div>

                <button type="submit" class="btn-primary" id="save-item-btn">
                    <span id="save-btn-text">Salvar Item</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Modais de Alerta/Confirmação -->
    <div class="modal-overlay" id="alert-modal">
        <div class="modal-content">
            <h3 id="alert-modal-title">Aviso</h3>
            <p id="alert-modal-message">Mensagem de alerta aqui.</p>
            <div class="modal-footer">
                <button class="btn-base btn-primary" id="alert-modal-ok">OK</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="confirm-modal">
        <div class="modal-content">
            <h3 id="confirm-modal-title">Confirmar Ação</h3>
            <p id="confirm-modal-message">Tem certeza?</p>
            <div class="modal-footer">
                <button class="btn-base btn-secondary" id="confirm-modal-cancel">Cancelar</button>
                <button class="btn-base btn-danger" id="confirm-modal-ok">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCn694_Aswhv1Fb2dn7pnWox4JVW66Xy2k",
            authDomain: "salgaderia-mestre.firebaseapp.com",
            projectId: "salgaderia-mestre",
            storageBucket: "salgaderia-mestre.firebasestorage.app",
            messagingSenderId: "280285587483",
            appId: "1:280285587483:web:0b36fab366f2e0f2b8b0be",
            measurementId: "G-1QSMWQ65ZZ"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        document.addEventListener('DOMContentLoaded', function() {
            // Elementos do DOM
            const menuGrid = document.getElementById('menu-grid');
            const addItemBtn = document.getElementById('add-item-btn');
            const itemModal = document.getElementById('item-modal');
            const itemForm = document.getElementById('item-form');
            const searchInput = document.getElementById('search-input');
            const filterButtons = document.querySelectorAll('.filter-btn');
            const timestampElement = document.getElementById('current-timestamp');

            let allMenuItems = [];
            let currentEditingItem = null;

            // Atualizar timestamp
            function updateTimestamp() {
                const now = new Date();
                const date = now.toLocaleDateString('pt-BR');
                const time = now.toLocaleTimeString('pt-BR');
                timestampElement.textContent = `${date} ${time}`;
            }
            setInterval(updateTimestamp, 1000);
            updateTimestamp();

            // Carregar itens do Firebase
            async function loadMenuItems() {
                try {
                    const querySnapshot = await db.collection("produtos").get();
                    allMenuItems = [];
                    
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        allMenuItems.push({
                            id: doc.id,
                            nome: data.nome || '',
                            categoria: data.categoria || '',
                            preco: data.preco || 0,
                            unidadesTexto: data.unidadesTexto || '',
                            imagemUrl: data.imagemUrl || '',
                            descricao: data.descricao || '',
                            nutricao: data.nutricao || {}
                        });
                    });
                    
                    renderMenuGrid(allMenuItems);
                    
                } catch (error) {
                    console.error("Erro ao carregar itens:", error);
                    showAlert('Erro ao carregar itens: ' + error.message);
                }
            }

            // Renderizar grade de itens
            function renderMenuGrid(items) {
                // Remover todos os itens exceto o botão de adicionar
                const existingItems = menuGrid.querySelectorAll('.menu-item-card:not(.add-item-card)');
                existingItems.forEach(item => item.remove());

                if (items.length === 0) {
                    const noResults = document.createElement('div');
                    noResults.className = 'no-results-message';
                    noResults.textContent = 'Nenhum item encontrado.';
                    noResults.style.gridColumn = '1 / -1';
                    menuGrid.appendChild(noResults);
                    return;
                }

                items.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'menu-item-card';
                    
                    const placeholder = `https://via.placeholder.com/200/EEEEEE/666666?text=${encodeURIComponent(item.nome.substring(0, 15))}`;
                    const imageSrc = item.imagemUrl || placeholder;

                    card.innerHTML = `
                        <img src="${imageSrc}" alt="${item.nome}" class="item-image" onerror="this.src='${placeholder}'">
                        <div class="item-info-bg"></div>
                        <div class="item-details">
                            <div class="item-title">${item.nome}</div>
                            <div class="item-units">${item.unidadesTexto}</div>
                        </div>
                        <div class="item-price-bg">
                            <span class="item-price">R$ ${Number(item.preco).toFixed(2).replace('.', ',')}</span>
                        </div>
                        <div class="item-actions">
                            <button class="action-btn edit" data-id="${item.id}"><i class="fa-solid fa-pencil"></i></button>
                            <button class="action-btn delete" data-id="${item.id}" data-name="${item.nome}"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    `;
                    
                    menuGrid.appendChild(card);
                });

                // Adicionar event listeners para editar/excluir
                document.querySelectorAll('.action-btn.edit').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openEditModal(e.target.closest('.action-btn').dataset.id);
                    });
                });

                document.querySelectorAll('.action-btn.delete').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const id = e.target.closest('.action-btn').dataset.id;
                        const name = e.target.closest('.action-btn').dataset.name;
                        confirmDelete(id, name);
                    });
                });
            }

            // Abrir modal para adicionar item
            addItemBtn.addEventListener('click', () => {
                openAddModal();
            });

            function openAddModal() {
                currentEditingItem = null;
                document.getElementById('modal-title').textContent = 'Adicionar Novo Item';
                document.getElementById('item-id').value = '';
                document.getElementById('item-form').reset();
                document.getElementById('image-preview').style.display = 'none';
                document.getElementById('upload-area').style.display = 'block';
                itemModal.classList.add('active');
            }

            async function openEditModal(itemId) {
                try {
                    const docRef = db.collection("produtos").doc(itemId);
                    const docSnap = await docRef.get();
                    
                    if (!docSnap.exists()) {
                        showAlert('Item não encontrado!');
                        return;
                    }

                    currentEditingItem = { id: docSnap.id, ...docSnap.data() };
                    
                    document.getElementById('modal-title').textContent = 'Editar Item';
                    document.getElementById('item-id').value = currentEditingItem.id;
                    document.getElementById('item-name').value = currentEditingItem.nome || '';
                    document.getElementById('item-category').value = currentEditingItem.categoria || '';
                    document.getElementById('item-price').value = currentEditingItem.preco || '';
                    document.getElementById('item-units').value = currentEditingItem.unidadesTexto || '';
                    document.getElementById('item-description').value = currentEditingItem.descricao || '';

                    // Preencher campos de nutrição
                    const nutricao = currentEditingItem.nutricao || {};
                    document.getElementById('nutrition-calories').value = nutricao.calorias || '';
                    document.getElementById('nutrition-carbs').value = nutricao.carboidratos || '';
                    document.getElementById('nutrition-proteins').value = nutricao.proteinas || '';
                    document.getElementById('nutrition-fats').value = nutricao.gorduras || '';
                    document.getElementById('nutrition-sodium').value = nutricao.sodio || '';
                    document.getElementById('nutrition-sugars').value = nutricao.acucares || '';

                    // Imagem
                    if (currentEditingItem.imagemUrl) {
                        document.getElementById('image-preview').src = currentEditingItem.imagemUrl;
                        document.getElementById('image-preview').style.display = 'block';
                        document.getElementById('upload-area').style.display = 'none';
                    } else {
                        document.getElementById('image-preview').style.display = 'none';
                        document.getElementById('upload-area').style.display = 'block';
                    }

                    itemModal.classList.add('active');

                } catch (error) {
                    console.error("Erro ao carregar item:", error);
                    showAlert('Erro ao carregar item: ' + error.message);
                }
            }

            // Upload de imagem
            document.getElementById('select-image-btn').addEventListener('click', () => {
                document.getElementById('item-image').click();
            });

            document.getElementById('item-image').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('image-preview').src = e.target.result;
                        document.getElementById('image-preview').style.display = 'block';
                        document.getElementById('upload-area').style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Salvar item
            itemForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const itemData = {
                    nome: document.getElementById('item-name').value.trim(),
                    categoria: document.getElementById('item-category').value,
                    preco: parseFloat(document.getElementById('item-price').value),
                    unidadesTexto: document.getElementById('item-units').value.trim(),
                    descricao: document.getElementById('item-description').value.trim(),
                    nutricao: {
                        calorias: document.getElementById('nutrition-calories').value.trim(),
                        carboidratos: document.getElementById('nutrition-carbs').value.trim(),
                        proteinas: document.getElementById('nutrition-proteins').value.trim(),
                        gorduras: document.getElementById('nutrition-fats').value.trim(),
                        sodio: document.getElementById('nutrition-sodium').value.trim(),
                        acucares: document.getElementById('nutrition-sugars').value.trim()
                    },
                    dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
                };

                // Validação dos campos obrigatórios
                if (!itemData.nome || !itemData.categoria || isNaN(itemData.preco) || !itemData.unidadesTexto) {
                    showAlert('Por favor, preencha todos os campos obrigatórios.');
                    return;
                }

                // Validação dos campos nutricionais obrigatórios
                if (!itemData.nutricao.calorias || !itemData.nutricao.carboidratos || 
                    !itemData.nutricao.proteinas || !itemData.nutricao.gorduras || 
                    !itemData.nutricao.sodio || !itemData.nutricao.acucares) {
                    showAlert('Por favor, preencha todos os campos da tabela nutricional.');
                    return;
                }

                try {
                    // Upload de imagem se houver
                    const imageFile = document.getElementById('item-image').files[0];
                    if (imageFile) {
                        const fileName = `produtos/${Date.now()}_${imageFile.name}`;
                        const storageRef = storage.ref().child(fileName);
                        await storageRef.put(imageFile);
                        itemData.imagemUrl = await storageRef.getDownloadURL();
                    } else if (currentEditingItem && currentEditingItem.imagemUrl) {
                        // Manter imagem existente se não foi alterada
                        itemData.imagemUrl = currentEditingItem.imagemUrl;
                    }

                    const itemId = document.getElementById('item-id').value;

                    if (itemId) {
                        // Atualizar item existente
                        await db.collection("produtos").doc(itemId).update(itemData);
                        showAlert('Item atualizado com sucesso!');
                    } else {
                        // Adicionar novo item
                        itemData.dataCriacao = firebase.firestore.FieldValue.serverTimestamp();
                        await db.collection("produtos").add(itemData);
                        showAlert('Item adicionado com sucesso!');
                    }

                    itemModal.classList.remove('active');
                    loadMenuItems();

                } catch (error) {
                    console.error("Erro ao salvar:", error);
                    showAlert('Erro ao salvar: ' + error.message);
                }
            });

            // Excluir item
            async function confirmDelete(itemId, itemName) {
                if (confirm(`Tem certeza que deseja excluir "${itemName}"?`)) {
                    try {
                        await db.collection("produtos").doc(itemId).delete();
                        showAlert('Item excluído com sucesso!');
                        loadMenuItems();
                    } catch (error) {
                        console.error("Erro ao excluir:", error);
                        showAlert('Erro ao excluir: ' + error.message);
                    }
                }
            }

            // Fechar modal
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.modal-overlay').forEach(modal => {
                        modal.classList.remove('active');
                    });
                });
            });

            // Filtros e busca
            searchInput.addEventListener('input', applyFilters);
            filterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    applyFilters();
                });
            });

            function applyFilters() {
                const searchTerm = searchInput.value.toLowerCase();
                const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;

                let filteredItems = allMenuItems;

                if (activeFilter !== 'all') {
                    filteredItems = filteredItems.filter(item => item.categoria === activeFilter);
                }

                if (searchTerm) {
                    filteredItems = filteredItems.filter(item => 
                        item.nome.toLowerCase().includes(searchTerm) ||
                        (item.descricao && item.descricao.toLowerCase().includes(searchTerm))
                    );
                }

                renderMenuGrid(filteredItems);
            }

            // Funções auxiliares
            function showAlert(message) {
                alert(message);
            }

            // Inicializar
            loadMenuItems();
        });
    </script>
</body>
</html>