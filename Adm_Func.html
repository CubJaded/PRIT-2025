<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Funcionários</title> 
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        /* --- Configurações Globais --- */
        :root {
            --color-primary: #b95c21;
            --color-secondary: #007bff;
            --color-danger: #d9534f;
            --color-warning: #f5a623;
            --color-success: #28a745;
            --color-text-dark: #333;
            --color-text-light: #555;
            --color-text-header: #777;
            --color-text-timestamp: #888;
            --color-border: #e9e9e9;
            --color-bg-page: #ffffff;
            --color-bg-light: #f9f9f9;
            --color-bg-table-header: #f1f1f1;
            --color-success-bg: #e9f7ec;
            --color-danger-bg: #fdeaea;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--color-bg-page);
            color: var(--color-text-dark);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* --- Header (Barra Laranja) --- */
        .top-bar {
            background-color: var(--color-primary);
            color: white;
            padding: 10px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-info .user-avatar { font-size: 36px; opacity: 0.9; }
        .user-info div { display: flex; flex-direction: column; font-size: 14px; }
        .user-info .user-name { font-weight: 600; }
        .user-info .user-role { font-size: 12px; opacity: 0.8; }
        
        /* --- HEADER NAV (CSS COM ESPAÇAMENTO CORRETO) --- */
        .header-nav { 
            display: flex; 
            align-items: center; 
        }
        .header-nav a {
            color: white;
            text-decoration: none;
            opacity: 0.8; 
            padding: 10px 15px; /* Define o espaçamento uniforme */
            border-radius: 6px; 
            transition: opacity 0.2s, background-color 0.2s;
        }
        .header-nav a:hover {
            opacity: 1; 
            background-color: rgba(255, 255, 255, 0.1); /* Efeito de hover */
        }
        .header-nav i { 
            font-size: 20px; 
            cursor: pointer; 
            display: block; 
        }
        /* --- FIM DA CORREÇÃO --- */

        /* --- Layout Principal --- */
        .page-container {
            max-width: 1100px;
            width: 95%;
            margin: 32px auto;
            padding: 24px;
            flex-grow: 1;
        }
        .page-header {
            position: relative;
            text-align: center;
            margin-bottom: 32px;
            padding-bottom: 16px;
        }
        .page-header h2 {
            font-size: 20px;
            font-weight: 400;
            color: var(--color-text-header);
            letter-spacing: 0.5px;
            display: inline-block;
            padding-bottom: 8px;
            border-bottom: 1px solid #ccc;
        }
        .page-header .timestamp {
            position: absolute;
            top: 0;
            right: 0;
            font-size: 16px;
            color: var(--color-text-light);
            font-weight: 500;
        }
        .section-title { font-size: 18px; font-weight: 500; color: var(--color-text-header); margin-bottom: 16px; border-bottom: 1px solid var(--color-border); padding-bottom: 8px; }

        /* --- KPIs (Cards de Resumo) --- */
        .kpi-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 32px; }
        .kpi-card { background-color: var(--color-bg-light); border: 1px solid var(--color-border); border-radius: 8px; padding: 20px; display: flex; align-items: flex-start; gap: 16px; }
        .kpi-card .icon { font-size: 24px; color: var(--color-primary); margin-top: 4px; }
        .kpi-card-info .kpi-title { font-size: 14px; color: var(--color-text-light); font-weight: 500; text-transform: uppercase; margin-bottom: 4px; }
        .kpi-card-info .kpi-value { font-size: 24px; font-weight: 600; color: var(--color-text-dark); }
        
        /* --- Controles (Busca e Botões) --- */
        .controls-container { 
            margin-bottom: 24px; 
            display: flex; 
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }
        .search-input { 
            padding: 10px 15px; 
            border: 1px solid var(--color-border); 
            border-radius: 6px; 
            font-size: 16px; 
            width: 100%; 
            max-width: 300px; 
        }
        .btn-primary { 
            background-color: var(--color-primary); 
            color: white; 
            border: none; 
            padding: 10px 16px; 
            border-radius: 6px; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: background-color 0.2s; 
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary:hover { background-color: #9d4d1c; }
        .btn-danger { 
            background-color: var(--color-danger); 
            color: white; 
            border: none; 
            padding: 10px 16px; 
            border-radius: 6px; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: background-color 0.2s; 
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-danger:hover { background-color: #c82333; }

        /* --- Tabela --- */
        .table-wrapper { width: 100%; overflow-x: auto; }
        .employee-table { width: 100%; border-collapse: collapse; background-color: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-radius: 8px; overflow: hidden; border: 1px solid var(--color-border); }
        .employee-table th, .employee-table td { padding: 14px 18px; text-align: left; vertical-align: middle; border-bottom: 1px solid var(--color-border); }
        .employee-table thead th { background-color: var(--color-bg-table-header); font-size: 13px; color: var(--color-text-light); text-transform: uppercase; white-space: nowrap; }
        .employee-table tbody tr:hover { background-color: #fcfcfc; }
        .employee-table tbody tr:last-child td { border-bottom: none; }
        .employee-info { display: flex; align-items: center; gap: 12px; }
        .employee-info img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 1px solid var(--color-border); }
        .employee-details .name { font-weight: 600; display: block; }
        .employee-details .role { font-size: 13px; color: var(--color-text-light); display: block; }
        .salary { font-weight: 600; }
        .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 5px 12px; border-radius: 15px; font-size: 13px; font-weight: 600; text-transform: uppercase; }
        .status-paid { background-color: var(--color-success-bg); color: var(--color-success); }
        .status-paid .icon { color: var(--color-success); }
        .status-fired { background-color: var(--color-danger-bg); color: var(--color-danger); }
        .status-fired .icon { color: var(--color-danger); }
        .actions button { 
            background: none; 
            border: 1px solid var(--color-border); 
            border-radius: 5px; 
            padding: 6px 12px; 
            margin-right: 5px; 
            cursor: pointer; 
            font-size: 13px; 
            transition: all 0.2s; 
            color: var(--color-text-light); 
        }
        .actions button:hover { background-color: var(--color-bg-light); color: var(--color-text-dark); }
        .actions .fire-btn:hover { background-color: var(--color-danger-bg); color: var(--color-danger); border-color: var(--color-danger); }
        
        /* --- Modal --- */
        .modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s ease-in-out; }
        .modal-overlay.active { display: flex; opacity: 1; }
        .modal-content { background-color: #fff; padding: 24px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); width: 90%; max-width: 500px; position: relative; transform: scale(0.95); transition: transform 0.2s ease-in-out; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-close { position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; color: #aaa; cursor: pointer; }
        .modal-close:hover { color: #333; }
        .modal-content h3 { margin-top: 0; margin-bottom: 20px; font-size: 20px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 14px; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid var(--color-border); border-radius: 6px; font-size: 16px; margin-bottom: 5px; }
        .btn-primary-modal { background-color: var(--color-primary); color: white; border: none; padding: 12px 16px; border-radius: 6px; font-size: 15px; font-weight: 600; cursor: pointer; transition: background-color 0.2s; width: 100%; }
        .btn-primary-modal:hover { background-color: #9d4d1c; }
        .btn-primary-modal:disabled { background-color: #aaa; cursor: not-allowed; }
        
        /* --- Profile Modal --- */
        .profile-modal-content { display: flex; flex-direction: column; align-items: center; text-align: center; }
        .profile-modal-content img { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 16px; border: 2px solid var(--color-primary); }
        .profile-modal-content .name { font-size: 22px; font-weight: 600; margin-bottom: 4px; }
        .profile-modal-content .role { font-size: 16px; color: var(--color-text-light); margin-bottom: 12px; }
        .profile-modal-content .salary { font-size: 18px; font-weight: 500; }
        
        /* --- Responsividade --- */
        @media (max-width: 768px) {
            .top-bar { flex-direction: column; gap: 16px; padding: 16px; }
            .header-nav { gap: 20px; flex-wrap: wrap; justify-content: center; }
            .page-header { text-align: left; display: flex; flex-direction: column; align-items: flex-start; gap: 8px; }
            .page-header h2 { font-size: 18px; }
            .page-header .timestamp { position: static; font-size: 14px; }
            .page-container { margin-top: 24px; padding: 16px; }
            .kpi-card-info .kpi-value { font-size: 20px; }
            .controls-container { justify-content: flex-start; }
            .search-input { max-width: none; }
            .employee-table th, .employee-table td { padding: 10px 12px; }
            .employee-info img { width: 35px; height: 35px; }
            .employee-details .name { font-size: 15px; }
            .employee-details .role { font-size: 12px; }
            .salary { font-size: 15px; }
            .status-badge { font-size: 12px; padding: 4px 10px; }
            .actions button { font-size: 12px; padding: 5px 8px; }
            .controls-container {
                flex-direction: column;
                align-items: stretch;
            }
            .btn-primary, .btn-danger {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body> 
    
    <header class="top-bar">
        <div class="user-info">
            <i class="fa-solid fa-user-circle user-avatar"></i>
            <div>
                <span class="user-name">Felipe</span>
                <span class="user-role">administração da plataforma</span>
            </div>
        </div>
        <nav class="header-nav">
            <a href="Adm_status.html"><i class="fa-solid fa-list-check" title="Status"></i></a>
            <a href="Adm_Ped.html"><i class="fa-solid fa-truck" title="Entregas"></i></a>
            <a href="Adm_anal.html"><i class="fa-solid fa-chart-line" title="Vendas"></i></a>
            <a href="Adam_estoq.html"><i class="fa-solid fa-box" title="Estoque"></i></a>
            <a href="Adm_agen.html"><i class="fa-solid fa-calendar-days" title="Agenda"></i></a>
            <a href="Adm_Func.html"><i class="fa-solid fa-user" title="Funcionários"></i></a>
            <a href="adm_adCard.html"><i class="fa-solid fa-utensils" title="Cardápio"></i></a>
            <a href="SalgaderiaMestreLogOn.html"><i class="fa-solid fa-arrow-right-from-bracket" title="Sair"></i></a>
        </nav>
    </header>

    <main class="page-container">
        <header class="page-header">
            <h2>FUNCIONÁRIOS SALGADERIA MESTRE</h2>
            <span class="timestamp" id="current-timestamp"></span>
        </header>
        
        <section class="kpi-container">
            <div class="kpi-card">
                <i class="fa-solid fa-users icon info"></i>
                <div class="kpi-card-info">
                    <span class="kpi-value" id="kpi-total-employees">0</span>
                    <span class="kpi-title">Total de Funcionários</span>
                </div>
            </div>
            <div class="kpi-card">
                <i class="fa-solid fa-hand-holding-dollar icon"></i>
                <div class="kpi-card-info">
                    <span class="kpi-title">Folha Mensal (Estimada)</span>
                    <span class="kpi-value" id="kpi-total-payroll">R$ 0,00</span>
                </div>
            </div>
            <div class="kpi-card">
                <i class="fa-solid fa-money-bill-trend-up icon"></i>
                <div class="kpi-card-info">
                    <span class="kpi-title">Salário Médio</span>
                    <span class="kpi-value" id="kpi-avg-salary">R$ 0,00</span>
                </div>
            </div>
        </section>

        <section class="controls-container">
            <input type="text" id="search-input" class="search-input" placeholder="Buscar funcionário por nome...">
            <div style="display: flex; gap: 10px;">
                <button class="btn-primary" id="add-employee-btn">
                    <i class="fa-solid fa-plus"></i> Adicionar Funcionário
                </button>
                <button class="btn-danger" id="fire-employee-btn" style="display: none;">
                    <i class="fa-solid fa-user-slash"></i> Demitir Funcionário
                </button>
            </div>
        </section>

        <section class="table-wrapper">
            <table class="employee-table">
                <thead>
                    <tr>
                        <th>Funcionário</th>
                        <th>Salário</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="employee-table-body">
                    <!-- Dados serão carregados via JavaScript -->
                </tbody>
            </table>
        </section>
    </main>

    <!-- Modal para Ver Perfil -->
    <div class="modal-overlay" id="profile-modal">
        <div class="modal-content profile-modal-content">
            <span class="modal-close" data-modal-id="profile-modal">&times;</span>
            <img id="profile-modal-picture" src="" alt="Foto do Funcionário">
            <span id="profile-modal-name" class="name">Nome do Funcionário</span>
            <span id="profile-modal-role" class="role">Cargo</span>
            <span id="profile-modal-salary" class="salary">Salário</span>
            <span id="profile-modal-status" class="status-badge" style="margin-top: 10px;"></span>
        </div>
    </div>

    <!-- Modal para Editar Funcionário -->
    <div class="modal-overlay" id="edit-modal">
        <div class="modal-content">
            <span class="modal-close" data-modal-id="edit-modal">&times;</span>
            <h3>Editar Funcionário</h3>
            <form id="edit-form">
                <input type="hidden" id="edit-employee-id">
                <div class="form-group">
                    <label for="edit-name">Nome</label>
                    <input type="text" id="edit-name" required>
                </div>
                <div class="form-group">
                    <label for="edit-role">Cargo</label>
                    <input type="text" id="edit-role" required>
                </div>
                <div class="form-group">
                    <label for="edit-salary">Salário (R$)</label>
                    <input type="number" step="0.01" id="edit-salary" required>
                </div>
                 <div class="form-group">
                    <label for="edit-picture">Caminho da Imagem</label>
                    <input type="text" id="edit-picture" placeholder="Ex: imagens_equipe/felipe.png">
                </div>
                <button type="submit" class="btn-primary-modal" id="save-edit-btn">Salvar Alterações</button>
            </form>
        </div>
    </div>

    <!-- Modal para Adicionar Funcionário -->
    <div class="modal-overlay" id="add-modal">
        <div class="modal-content">
            <span class="modal-close" data-modal-id="add-modal">&times;</span>
            <h3>Adicionar Novo Funcionário</h3>
            <form id="add-form">
                <div class="form-group">
                    <label for="add-name">Nome</label>
                    <input type="text" id="add-name" required placeholder="Nome completo">
                </div>
                <div class="form-group">
                    <label for="add-role">Cargo</label>
                    <input type="text" id="add-role" required placeholder="Ex: Padeiro, Atendente">
                </div>
                <div class="form-group">
                    <label for="add-salary">Salário (R$)</label>
                    <input type="number" step="0.01" id="add-salary" required placeholder="0.00">
                </div>
                <div class="form-group">
                    <label for="add-picture">Caminho da Imagem</label>
                    <input type="text" id="add-picture" placeholder="Ex: imagens_equipe/funcionario.png">
                </div>
                <button type="submit" class="btn-primary-modal" id="save-add-btn">Adicionar Funcionário</button>
            </form>
        </div>
    </div>

    <!-- Modal para Demitir Funcionário -->
    <div class="modal-overlay" id="fire-modal">
        <div class="modal-content">
            <span class="modal-close" data-modal-id="fire-modal">&times;</span>
            <h3>Demitir Funcionário</h3>
            <div class="form-group">
                <p>Tem certeza que deseja demitir <strong id="fire-employee-name"></strong>?</p>
                <p style="color: var(--color-danger); font-size: 14px; margin-top: 10px;">
                    <i class="fa-solid fa-triangle-exclamation"></i> Esta ação não pode ser desfeita.
                </p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button type="button" class="btn-primary-modal" id="cancel-fire-btn" style="background-color: #6c757d;">Cancelar</button>
                <button type="button" class="btn-primary-modal" id="confirm-fire-btn" style="background-color: var(--color-danger);">Confirmar Demissão</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- 1. IMPORTS DO FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { 
            getFirestore, collection, getDocs, 
            doc, updateDoc, addDoc, deleteDoc, query, orderBy
        } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
        
        // --- 2. CONFIGURAÇÃO DO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCn694_Aswhv1Fb2dn7pnWox4JVW66Xy2k",
            authDomain: "salgaderia-mestre.firebaseapp.com",
            projectId: "salgaderia-mestre",
            storageBucket: "salgaderia-mestre.firebasestorage.app",
            messagingSenderId: "280285587483",
            appId: "1:280285587483:web:0b36fab366f2e0f2b8b0be",
            measurementId: "G-1QSMWQ65ZZ"
        };

        // --- 3. INICIALIZAÇÃO ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const funcionariosCollectionRef = collection(db, "funcionarios");

        // --- 4. SELETORES DO DOM ---
        const timestampElement = document.getElementById('current-timestamp');
        const tableBody = document.getElementById('employee-table-body');
        const searchInput = document.getElementById('search-input');
        const kpiTotalEmployees = document.getElementById('kpi-total-employees');
        const kpiTotalPayroll = document.getElementById('kpi-total-payroll');
        const kpiAvgSalary = document.getElementById('kpi-avg-salary');
        
        // Botões de ação
        const addEmployeeBtn = document.getElementById('add-employee-btn');
        const fireEmployeeBtn = document.getElementById('fire-employee-btn');
        
        // Modais
        const profileModal = document.getElementById('profile-modal');
        const editModal = document.getElementById('edit-modal');
        const addModal = document.getElementById('add-modal');
        const fireModal = document.getElementById('fire-modal');
        const modalCloseButtons = document.querySelectorAll('.modal-close');
        const editForm = document.getElementById('edit-form');
        const addForm = document.getElementById('add-form');
        
        // Elementos do modal de demissão
        const fireEmployeeName = document.getElementById('fire-employee-name');
        const cancelFireBtn = document.getElementById('cancel-fire-btn');
        const confirmFireBtn = document.getElementById('confirm-fire-btn');
        
        let localEmployeeData = []; // Array local para busca
        let selectedEmployeeForFire = null; // Funcionário selecionado para demissão

        // --- 5. ATUALIZAÇÃO DO TIMESTAMP ---
        function updateCurrentTime() {
            const now = new Date();
            const optionsDate = { day: '2-digit', month: '2-digit', year: '2-digit' };
            const optionsTime = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
            const date = now.toLocaleDateString('pt-BR', optionsDate);
            const time = now.toLocaleTimeString('pt-BR', optionsTime);
            if (timestampElement) { timestampElement.textContent = `${date} ${time}`; }
        }
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);

        // --- 6. FUNÇÃO PARA RENDERIZAR A TABELA ---
        function renderTable(data) {
            tableBody.innerHTML = '';
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--color-text-light);">Nenhum funcionário encontrado.</td></tr>';
                return;
            }

            data.forEach(employee => {
                const row = document.createElement('tr');
                row.setAttribute('data-id', employee.id);

                const formattedSalary = Number(employee.salario).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                const placeholder = `https://via.placeholder.com/45/CCCCCC/FFFFFF?text=${employee.nome.charAt(0)}`;
                const pictureSrc = employee.fotoPath || placeholder;
                
                // Determina o status
                const isFired = employee.status === 'Demitido';
                const statusClass = isFired ? 'status-fired' : 'status-paid';
                const statusText = isFired ? 'Demitido' : (employee.statusPagamento || 'Pago');
                const statusIcon = isFired ? 'fa-solid fa-user-slash' : 'fa-solid fa-check-circle';

                row.innerHTML = `
                    <td>
                        <div class="employee-info">
                            <img src="${pictureSrc}" alt="${employee.nome}" onerror="this.src='${placeholder}'; this.style.border='none';">
                            <div class="employee-details">
                                <span class="name">${employee.nome}</span>
                                <span class="role">${employee.cargo}</span>
                            </div>
                        </div>
                    </td>
                    <td><span class="salary">${formattedSalary}</span></td>
                    <td>
                        <span class="status-badge ${statusClass}">
                            ${statusText}
                            <i class="${statusIcon} icon"></i>
                        </span>
                    </td>
                    <td class="actions">
                        <button class="view-btn" title="Ver Perfil" data-id="${employee.id}"><i class="fa-solid fa-eye"></i></button>
                        <button class="edit-btn" title="Editar" data-id="${employee.id}" ${isFired ? 'disabled style="opacity: 0.5;"' : ''}><i class="fa-solid fa-pencil"></i></button>
                        <button class="fire-btn" title="${isFired ? 'Funcionário Demitido' : 'Demitir'}" data-id="${employee.id}" ${isFired ? 'disabled style="opacity: 0.5;"' : ''}><i class="fa-solid fa-user-slash"></i></button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Adiciona listeners aos botões
            tableBody.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', (e) => openProfileModal(e.currentTarget.dataset.id));
            });
            tableBody.querySelectorAll('.edit-btn').forEach(btn => {
                if (!btn.disabled) {
                    btn.addEventListener('click', (e) => openEditModal(e.currentTarget.dataset.id));
                }
            });
            tableBody.querySelectorAll('.fire-btn').forEach(btn => {
                if (!btn.disabled) {
                    btn.addEventListener('click', (e) => openFireModal(e.currentTarget.dataset.id));
                }
            });
        }

        // --- 7. FUNÇÃO PARA ATUALIZAR KPIs ---
        function updateKPIs(data) {
            // Filtra apenas funcionários ativos
            const activeEmployees = data.filter(emp => emp.status !== 'Demitido');
            const totalEmployees = activeEmployees.length;
            const totalPayroll = activeEmployees.reduce((sum, emp) => sum + Number(emp.salario || 0), 0);
            const avgSalary = totalEmployees > 0 ? totalPayroll / totalEmployees : 0;

            kpiTotalEmployees.textContent = totalEmployees;
            kpiTotalPayroll.textContent = totalPayroll.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            kpiAvgSalary.textContent = avgSalary.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        // --- 8. LÓGICA DA BUSCA ---
        function applySearch() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const filteredData = localEmployeeData.filter(employee =>
                employee.nome.toLowerCase().includes(searchTerm)
            );
            renderTable(filteredData);
        }
        searchInput.addEventListener('input', applySearch);
        
        // --- 9. LÓGICA DOS MODAIS ---
        function openProfileModal(employeeId) {
            const employee = localEmployeeData.find(emp => emp.id === employeeId);
            if (!employee) return;
            
            const placeholder = `https://via.placeholder.com/100/CCCCCC/FFFFFF?text=${employee.nome.charAt(0)}`;
            const pictureSrc = employee.fotoPath || placeholder;
            
            const profilePic = document.getElementById('profile-modal-picture');
            profilePic.src = pictureSrc;
            profilePic.onerror = () => { profilePic.src = placeholder; profilePic.style.border = 'none'; };
            
            document.getElementById('profile-modal-name').textContent = employee.nome;
            document.getElementById('profile-modal-role').textContent = employee.cargo;
            document.getElementById('profile-modal-salary').textContent = Number(employee.salario).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            
            // Atualiza o status no modal
            const statusElement = document.getElementById('profile-modal-status');
            const isFired = employee.status === 'Demitido';
            statusElement.textContent = isFired ? 'Demitido' : (employee.statusPagamento || 'Ativo');
            statusElement.className = `status-badge ${isFired ? 'status-fired' : 'status-paid'}`;
            statusElement.innerHTML = `${isFired ? 'Demitido' : (employee.statusPagamento || 'Ativo')} <i class="${isFired ? 'fa-solid fa-user-slash' : 'fa-solid fa-check-circle'} icon"></i>`;
            
            profileModal.classList.add('active');
        }

        function openEditModal(employeeId) {
            const employee = localEmployeeData.find(emp => emp.id === employeeId);
            if (!employee) return;

            document.getElementById('edit-employee-id').value = employee.id;
            document.getElementById('edit-name').value = employee.nome;
            document.getElementById('edit-role').value = employee.cargo;
            document.getElementById('edit-salary').value = Number(employee.salario).toFixed(2);
            document.getElementById('edit-picture').value = employee.fotoPath || '';

            editModal.classList.add('active');
        }

        function openAddModal() {
            addForm.reset();
            addModal.classList.add('active');
        }

        function openFireModal(employeeId) {
            const employee = localEmployeeData.find(emp => emp.id === employeeId);
            if (!employee) return;

            selectedEmployeeForFire = employee;
            fireEmployeeName.textContent = employee.nome;
            fireModal.classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            if (modalId === 'fire-modal') {
                selectedEmployeeForFire = null;
            }
        }

        // Configuração dos listeners dos modais
        modalCloseButtons.forEach(button => {
            button.addEventListener('click', (e) => closeModal(e.currentTarget.dataset.modalId));
        });
        
        [profileModal, editModal, addModal, fireModal].forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal(modal.id);
            });
        });

        // Botões de ação
        addEmployeeBtn.addEventListener('click', openAddModal);
        
        cancelFireBtn.addEventListener('click', () => closeModal('fire-modal'));
        
        confirmFireBtn.addEventListener('click', async () => {
            if (!selectedEmployeeForFire) return;
            
            try {
                const docRef = doc(db, "funcionarios", selectedEmployeeForFire.id);
                await updateDoc(docRef, {
                    status: 'Demitido',
                    dataDemissao: new Date().toISOString().split('T')[0]
                });
                
                alert(`${selectedEmployeeForFire.nome} foi demitido com sucesso!`);
                closeModal('fire-modal');
                loadAndRenderTable(); // Recarrega os dados
            } catch (error) {
                console.error("Erro ao demitir funcionário: ", error);
                alert("Falha ao demitir funcionário.");
            }
        });

        // Salvar Edição no Firestore
        editForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const saveButton = document.getElementById('save-edit-btn');
            saveButton.disabled = true;
            saveButton.textContent = "Salvando...";
            
            const id = document.getElementById('edit-employee-id').value;
            
            const updatedData = {
                nome: document.getElementById('edit-name').value.trim(),
                cargo: document.getElementById('edit-role').value.trim(),
                salario: parseFloat(document.getElementById('edit-salary').value),
                fotoPath: document.getElementById('edit-picture').value.trim()
            };

            if (!updatedData.nome || !updatedData.cargo || isNaN(updatedData.salario)) {
                alert("Nome, Cargo e Salário são obrigatórios.");
                saveButton.disabled = false;
                saveButton.textContent = "Salvar Alterações";
                return;
            }

            try {
                const docRef = doc(db, "funcionarios", id);
                await updateDoc(docRef, updatedData);
                
                alert("Funcionário atualizado com sucesso!");
                closeModal('edit-modal');
                loadAndRenderTable(); // Recarrega tudo do Firestore
            } catch (error) {
                console.error("Erro ao atualizar funcionário: ", error);
                alert("Falha ao atualizar.");
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = "Salvar Alterações";
            }
        });

        // Adicionar Novo Funcionário
        addForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const saveButton = document.getElementById('save-add-btn');
            saveButton.disabled = true;
            saveButton.textContent = "Adicionando...";
            
            const newEmployee = {
                nome: document.getElementById('add-name').value.trim(),
                cargo: document.getElementById('add-role').value.trim(),
                salario: parseFloat(document.getElementById('add-salary').value),
                fotoPath: document.getElementById('add-picture').value.trim(),
                statusPagamento: 'Pago',
                status: 'Ativo',
                dataAdmissao: new Date().toISOString().split('T')[0]
            };

            if (!newEmployee.nome || !newEmployee.cargo || isNaN(newEmployee.salario)) {
                alert("Nome, Cargo e Salário são obrigatórios.");
                saveButton.disabled = false;
                saveButton.textContent = "Adicionar Funcionário";
                return;
            }

            try {
                await addDoc(funcionariosCollectionRef, newEmployee);
                
                alert("Funcionário adicionado com sucesso!");
                closeModal('add-modal');
                loadAndRenderTable(); // Recarrega tudo do Firestore
            } catch (error) {
                console.error("Erro ao adicionar funcionário: ", error);
                alert("Falha ao adicionar funcionário.");
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = "Adicionar Funcionário";
            }
        });

        // --- 10. CARREGAMENTO INICIAL DO FIRESTORE ---
        async function loadAndRenderTable() {
            try {
                // Ordena por nome
                const q = query(funcionariosCollectionRef, orderBy("nome", "asc"));
                const querySnapshot = await getDocs(q);
                
                localEmployeeData = [];
                querySnapshot.forEach((doc) => {
                    localEmployeeData.push({ id: doc.id, ...doc.data() });
                });
                
                renderTable(localEmployeeData);
                updateKPIs(localEmployeeData);
            } catch (error) {
                console.error("Erro ao carregar funcionários: ", error);
                 if (error.code === 'failed-precondition') {
                    console.warn("Firestore: Índice não encontrado para 'nome'. Carregando sem ordenação.");
                    const fallbackSnapshot = await getDocs(funcionariosCollectionRef);
                    localEmployeeData = [];
                    fallbackSnapshot.forEach((doc) => {
                        localEmployeeData.push({ id: doc.id, ...doc.data() });
                    });
                    renderTable(localEmployeeData);
                    updateKPIs(localEmployeeData);
                 } else {
                    tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: red;">Falha ao carregar dados.</td></tr>';
                 }
            }
        }

        // --- 11. INICIALIZAÇÃO ---
        loadAndRenderTable(); // Carrega os dados ao iniciar

    </script>
</body>
</html>