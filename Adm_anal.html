
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Análise de Vendas</title> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* --- Configurações Globais --- */
        :root {
            --color-primary: #b95c21;
            --color-secondary: #007bff;
            --color-danger: #d9534f;
            --color-warning: #f5a623;
            --color-success: #28a745;
            --color-text-dark: #333;
            --color-text-light: #555;
            --color-text-header: #777;
            --color-text-timestamp: #888;
            --color-border: #e9e9e9;
            --color-bg-page: #ffffff;
            --color-bg-light: #f9f9f9;
            --color-bg-table-header: #f1f1f1;
            --color-success-bg: #e9f7ec;
            --color-card-title-bg: rgba(255, 255, 255, 0.6);
            --color-card-price-bg: #8c4a28;
            /* Cores específicas do Gráfico */
            --color-bar-green: #28a745; 
            --color-bar-blue: #007bff;  
            --color-bar-red: #b32a31;   
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--color-bg-page);
            color: var(--color-text-dark);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* --- Header (Barra Laranja) --- */
       /* --- Header (Barra Laranja) --- */
        .top-bar {
            background-color: var(--color-primary);
            color: white;
            padding: 10px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-info .user-avatar { font-size: 36px; opacity: 0.9; }
        .user-info div { display: flex; flex-direction: column; font-size: 14px; }
        .user-info .user-name { font-weight: 600; }
        .user-info .user-role { font-size: 12px; opacity: 0.8; }
        
        /* --- CSS DA NAVBAR ATUALIZADO --- */
        .header-nav { 
            display: flex; 
            align-items: center; 
            /* Removemos o 'gap' para controle total */
        }
        .header-nav a {
            color: white;
            text-decoration: none;
            opacity: 0.8; 
            
            /* A MÁGICA ESTÁ AQUI:
            Adicionamos padding (espaçamento interno) a CADA link.
            10px em cima/baixo e 15px nos lados.
            Isso cria uma "caixa" de clique igual para cada ícone.
            O espaço entre os ícones será de 15px + 15px = 30px.
            */
            padding: 10px 15px; 
            border-radius: 6px; /* Deixa o hover mais bonito */
            transition: opacity 0.2s, background-color 0.2s;
        }
        .header-nav a:hover {
            opacity: 1; /* Ícone fica 100% visível */
            background-color: rgba(255, 255, 255, 0.1); /* Efeito de fundo sutil */
        }
        .header-nav i { 
            font-size: 20px; 
            cursor: pointer; 
            display: block; /* Garante que o ícone se alinhe bem */
        }
        /* --- FIM DA ATUALIZAÇÃO --- */

        /* --- Layout Principal --- */
        .page-container {
            max-width: 1100px;
            width: 95%;
            margin: 32px auto;
            padding: 24px;
            flex-grow: 1;
        }
        .page-header {
            position: relative;
            text-align: center;
            margin-bottom: 32px;
            padding-bottom: 16px;
        }
        .page-header h2 {
            font-size: 20px;
            font-weight: 400;
            color: var(--color-text-header);
            letter-spacing: 0.5px;
            display: inline-block;
            padding-bottom: 8px;
            border-bottom: 1px solid #ccc;
        }
        .page-header .timestamp {
            position: absolute;
            top: 0;
            right: 0;
            font-size: 16px;
            color: var(--color-text-light);
            font-weight: 500;
        }
        .section-title { font-size: 18px; font-weight: 500; color: var(--color-text-header); margin-bottom: 16px; border-bottom: 1px solid var(--color-border); padding-bottom: 8px; }

        /* --- KPIs (Cards de Resumo) --- */
        .kpi-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 32px; }
        .kpi-card { background-color: var(--color-bg-light); border: 1px solid var(--color-border); border-radius: 8px; padding: 20px; display: flex; align-items: center; gap: 16px; }
        .kpi-card .icon { font-size: 28px; width: 40px; text-align: center; }
        .kpi-card .icon.success { color: var(--color-success); }
        .kpi-card .icon.warning { color: var(--color-warning); }
        .kpi-card .icon.danger { color: var(--color-danger); }
        .kpi-card .icon.info, .kpi-card .icon.total { color: var(--color-primary); }
        .kpi-card-info .kpi-value { font-size: 24px; font-weight: 600; color: var(--color-text-dark); display: block; margin-bottom: 4px; }
        .kpi-card-info .kpi-title { font-size: 13px; color: var(--color-text-light); font-weight: 500; text-transform: uppercase; }

        /* --- Gráfico (Vendas) --- */
        .chart-section { display: flex; flex-direction: column; align-items: center; gap: 30px; margin-bottom: 40px; }
        .bar-chart-container { position: relative; width: 100%; max-width: 700px; height: 400px; padding-left: 50px; }
        .y-axis { position: absolute; left: 0; top: 0; width: 100%; height: 100%; margin-left: 50px; z-index: 1; }
        .y-axis::before { content: ''; position: absolute; left: 0; top: 0; width: 1px; height: calc(100% - 40px); background-color: var(--color-text-dark); }
        .y-axis::after { content: ''; position: absolute; left: 0; bottom: 40px; width: calc(100% - 50px); height: 1px; background-color: var(--color-text-dark); }
        .y-axis-label { position: absolute; left: -40px; font-size: 13px; color: var(--color-text-light); text-align: right; width: 35px; }
        .grid-line { position: absolute; width: calc(100% - 50px); height: 1px; background-color: var(--color-grid-line); z-index: 0; left: 0; }
        .y-axis-label[data-value="0"] { bottom: 40px; transform: translateY(50%); left: -45px; }
        .y-axis-label[data-value="50"] { bottom: calc(40px + (360px * 0.1)); transform: translateY(50%); }
        .grid-line[data-value="50"] { bottom: calc(40px + (360px * 0.1)); }
        .y-axis-label[data-value="100"] { bottom: calc(40px + (360px * 0.2)); transform: translateY(50%); }
        .grid-line[data-value="100"] { bottom: calc(40px + (360px * 0.2)); }
        .y-axis-label[data-value="150"] { bottom: calc(40px + (360px * 0.3)); transform: translateY(50%); }
        .grid-line[data-value="150"] { bottom: calc(40px + (360px * 0.3)); }
        .y-axis-label[data-value="200"] { bottom: calc(40px + (360px * 0.4)); transform: translateY(50%); }
        .grid-line[data-value="200"] { bottom: calc(40px + (360px * 0.4)); }
        .y-axis-label[data-value="250"] { bottom: calc(40px + (360px * 0.5)); transform: translateY(50%); }
        .grid-line[data-value="250"] { bottom: calc(40px + (360px * 0.5)); }
        .y-axis-label[data-value="300"] { bottom: calc(40px + (360px * 0.6)); transform: translateY(50%); }
        .grid-line[data-value="300"] { bottom: calc(40px + (360px * 0.6)); }
        .y-axis-label[data-value="350"] { bottom: calc(40px + (360px * 0.7)); transform: translateY(50%); }
        .grid-line[data-value="350"] { bottom: calc(40px + (360px * 0.7)); }
        .y-axis-label[data-value="400"] { bottom: calc(40px + (360px * 0.8)); transform: translateY(50%); }
        .grid-line[data-value="400"] { bottom: calc(40px + (360px * 0.8)); }
        .y-axis-label[data-value="450"] { bottom: calc(40px + (360px * 0.9)); transform: translateY(50%); }
        .grid-line[data-value="450"] { bottom: calc(40px + (360px * 0.9)); }
        .y-axis-label[data-value="500+"] { bottom: calc(40px + 360px); transform: translateY(50%); }
        .grid-line[data-value="500"] { bottom: calc(40px + 360px); }

        .chart-scroll-wrapper { position: absolute; left: 50px; top: 0; width: calc(100% - 50px); height: 100%; overflow-x: auto; overflow-y: hidden; z-index: 5; }
        .bars { position: relative; width: 1000px; height: 100%; display: flex; align-items: flex-end; justify-content: space-around; padding: 0 10px; padding-bottom: 40px; }
        .bar-item { width: 10%; background-color: lightgray; border-top-left-radius: 3px; border-top-right-radius: 3px; transition: height 0.5s ease-out; position: relative; }
        .bar-item.green { background-color: var(--color-bar-green); }
        .bar-item.blue { background-color: var(--color-bar-blue); }
        .bar-item.red { background-color: var(--color-bar-red); }
        .bar-label { position: absolute; bottom: -30px; left: 50%; transform: translateX(-50%); font-size: 16px; font-weight: 600; color: var(--color-text-dark); white-space: nowrap; }
        .chart-legend { display: flex; flex-wrap: wrap; justify-content: center; gap: 24px; width: 100%; }
        .legend-item { display: flex; align-items: center; gap: 10px; font-size: 14px; color: var(--color-text-dark); font-weight: 500; }
        .legend-color { width: 20px; height: 20px; border-radius: 2px; }
        .legend-color.green { background-color: var(--color-bar-green); }
        .legend-color.blue { background-color: var(--color-bar-blue); }
        .legend-color.red { background-color: var(--color-bar-red); }

        /* --- Tabela de Dados --- */
        .table-wrapper { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; background-color: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-radius: 8px; overflow: hidden; border: 1px solid var(--color-border); }
        th, td { padding: 14px 18px; text-align: left; vertical-align: middle; border-bottom: 1px solid var(--color-border); }
        thead th { background-color: var(--color-bg-table-header); font-size: 13px; color: var(--color-text-light); text-transform: uppercase; white-space: nowrap; }
        tbody tr:hover { background-color: #fcfcfc; }
        tbody tr:last-child td { border-bottom: none; }
        .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 5px 12px; border-radius: 15px; font-size: 13px; font-weight: 600; text-transform: uppercase; }
        .status-badge.status-green { background-color: var(--color-success-bg); color: var(--color-success); }
        .status-badge.status-blue { background-color: #e6f2ff; color: var(--color-secondary); }
        .status-badge.status-red { background-color: #fdecea; color: var(--color-danger); }
        
        /* --- Responsividade --- */
        @media (max-width: 768px) {
            .top-bar { flex-direction: column; gap: 16px; padding: 16px; }
            .header-nav { gap: 20px; flex-wrap: wrap; justify-content: center; }
            .page-header { text-align: left; display: flex; flex-direction: column; align-items: flex-start; gap: 8px; }
            .page-header h2 { font-size: 18px; }
            .page-header .timestamp { position: static; font-size: 14px; }
            .page-container { margin-top: 24px; padding: 16px; }
            .kpi-card-info .kpi-value { font-size: 20px; }
            .bar-chart-container { max-width: 100%; height: 300px; padding-left: 40px; padding-bottom: 30px; }
            .y-axis::before { height: calc(100% - 30px); }
            .y-axis::after { bottom: 30px; }
            .y-axis-label { left: -35px; font-size: 12px; }
            .y-axis-label[data-value="0"] { left: -40px; bottom: 30px; }
            /* Ajustes para 270px de área de gráfico */
            .y-axis-label[data-value="50"] { bottom: calc(30px + (270px * 0.1)); }
            .grid-line[data-value="50"] { bottom: calc(30px + (270px * 0.1)); }
            .y-axis-label[data-value="100"] { bottom: calc(30px + (270px * 0.2)); }
            .grid-line[data-value="100"] { bottom: calc(30px + (270px * 0.2)); }
            .y-axis-label[data-value="150"] { bottom: calc(30px + (270px * 0.3)); }
            .grid-line[data-value="150"] { bottom: calc(30px + (270px * 0.3)); }
            .y-axis-label[data-value="200"] { bottom: calc(30px + (270px * 0.4)); }
            .grid-line[data-value="200"] { bottom: calc(30px + (270px * 0.4)); }
            .y-axis-label[data-value="250"] { bottom: calc(30px + (270px * 0.5)); }
            .grid-line[data-value="250"] { bottom: calc(30px + (270px * 0.5)); }
            .y-axis-label[data-value="300"] { bottom: calc(30px + (270px * 0.6)); }
            .grid-line[data-value="300"] { bottom: calc(30px + (270px * 0.6)); }
            .y-axis-label[data-value="350"] { bottom: calc(30px + (270px * 0.7)); }
            .grid-line[data-value="350"] { bottom: calc(30px + (270px * 0.7)); }
            .y-axis-label[data-value="400"] { bottom: calc(30px + (270px * 0.8)); }
            .grid-line[data-value="400"] { bottom: calc(30px + (270px * 0.8)); }
            .y-axis-label[data-value="450"] { bottom: calc(30px + (270px * 0.9)); }
            .grid-line[data-value="450"] { bottom: calc(30px + (270px * 0.9)); }
            .y-axis-label[data-value="500+"] { bottom: calc(30px + 270px); }
            .grid-line[data-value="500"] { bottom: calc(30px + 270px); }
            
            .chart-scroll-wrapper { left: 40px; width: calc(100% - 40px); height: 100%; }
            .bars { width: 800px; padding-bottom: 30px; }
            .bar-item { width: 10%; }
            .bar-label { font-size: 13px; bottom: -25px; }
            .chart-legend { gap: 16px; }
            .legend-item { font-size: 13px; gap: 6px; }
            .legend-color { width: 14px; height: 14px; }
        }
    </style>
</head>
<body> 
    
    <header class="top-bar">
        <div class="user-info">
            <i class="fa-solid fa-user-circle user-avatar"></i>
            <div>
                <span class="user-name">Felipe</span>
                <span class="user-role">administração da plataforma</span>
            </div>
        </div>
        <nav class="header-nav">
      <a href="Adm_status.html"><i class="fa-solid fa-list-check" title="Status"></i></a>
      <a href="Adm_Ped.html"><i class="fa-solid fa-truck" title="Entregas"></i></a>
      <a href="Adm_anal.html"><i class="fa-solid fa-chart-line" title="Vendas"></i></a>
      <a href="Adam_estoq.html"><i class="fa-solid fa-box" title="Estoque"></i></a>
      <a href="Adm_agen.html"><i class="fa-solid fa-calendar-days" title="Agenda"></i></a>
      <a href="Adm_Func.html"><i class="fa-solid fa-user" title="Funcionários"></i></a>
      <a href="adm_adCard.html"><i class="fa-solid fa-utensils" title="Cardápio"></i></a>  <a href="SalgaderiaMestreLogOn.html"><i class="fa-solid fa-arrow-right-from-bracket" title="Sair"></i></a>
     </nav>
    </header>

    <main class="page-container">
        <header class="page-header">
            <h2>ANALISE MENSAL DE VENDAS</h2>
            <span class="timestamp" id="current-timestamp"></span>
        </header>

        <section class="kpi-container">
            <div class="kpi-card">
                <i class="fa-solid fa-cash-register icon total"></i>
                <div class="kpi-card-info">
                    <span class="kpi-value" id="kpi-total-units">0</span>
                    <span class="kpi-title">Faturamento (Unid.)</span>
                </div>
            </div>
            <div class="kpi-card">
                <i class="fa-solid fa-calculator icon info"></i>
                <div class="kpi-card-info">
                    <span class="kpi-value" id="kpi-avg-units">0</span>
                    <span class="kpi-title">Média Mensal</span>
                </div>
            </div>
            <div class="kpi-card">
                <i class="fa-solid fa-arrow-trend-up icon success"></i>
                <div class="kpi-card-info">
                    <span class="kpi-value" id="kpi-best-month">--</span>
                    <span class="kpi-title">Melhor Mês</span>
                </div>
            </div>
            <div class="kpi-card">
                <i class="fa-solid fa-arrow-trend-down icon danger"></i>
                <div class="kpi-card-info">
                    <span class="kpi-value" id="kpi-worst-month">--</span>
                    <span class="kpi-title">Pior Mês</span>
                </div>
            </div>
        </section>

        <section class="chart-section">
            <div class="bar-chart-container">
                <div class="y-axis">
                    <span class="y-axis-label" data-value="0">0</span>
                    <span class="y-axis-label" data-value="50">50</span><div class="grid-line" data-value="50"></div>
                    <span class="y-axis-label" data-value="100">100</span><div class="grid-line" data-value="100"></div>
                    <span class="y-axis-label" data-value="150">150</span><div class="grid-line" data-value="150"></div>
                    <span class="y-axis-label" data-value="200">200</span><div class="grid-line" data-value="200"></div>
                    <span class="y-axis-label" data-value="250">250</span><div class="grid-line" data-value="250"></div>
                    <span class="y-axis-label" data-value="300">300</span><div class="grid-line" data-value="300"></div>
                    <span class="y-axis-label" data-value="350">350</span><div class="grid-line" data-value="350"></div>
                    <span class="y-axis-label" data-value="400">400</span><div class="grid-line" data-value="400"></div>
                    <span class="y-axis-label" data-value="450">450</span><div class="grid-line" data-value="450"></div>
                    <span class="y-axis-label" data-value="500+">500+</span><div class="grid-line" data-value="500"></div>
                </div>

                <div class="chart-scroll-wrapper">
                    <div class="bars" id="chart-bars">
                        </div>
                </div>
            </div>

            <div class="chart-legend">
                <div class="legend-item">
                    <span class="legend-color green"></span>
                    <span>VENDAS ACIMA</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color blue"></span>
                    <span>VENDAS NORMAIS</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color red"></span>
                    <span>VENDAS ABAIXO</span>
                </div>
            </div>
        </section>
        
        <section class="data-table-container">
            <h2 class="section-title">Dados Detalhados</h2>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Mês</th>
                            <th>Vendas (Unidades)</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body">
                        </tbody>
                </table>
            </div>
        </section>
    </main>

    <script type="module">
        // --- 1. IMPORTS DO FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { 
            getFirestore, collection, getDocs, query, orderBy 
        } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
        
        // --- 2. CONFIGURAÇÃO DO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCn694_Aswhv1Fb2dn7pnWox4JVW66Xy2k",
            authDomain: "salgaderia-mestre.firebaseapp.com",
            projectId: "salgaderia-mestre",
            storageBucket: "salgaderia-mestre.firebasestorage.app",
            messagingSenderId: "280285587483",
            appId: "1:280285587483:web:0b36fab366f2e0f2b8b0be",
            measurementId: "G-1QSMWQ65ZZ"
        };

        // --- 3. INICIALIZAÇÃO ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const vendasCollectionRef = collection(db, "vendas_mensais");

        // --- 4. SELETORES DO DOM ---
        const timestampElement = document.getElementById('current-timestamp');
        const barsContainer = document.getElementById('chart-bars');
        const tableBody = document.getElementById('data-table-body');
        const kpiTotalUnits = document.getElementById('kpi-total-units');
        const kpiAvgUnits = document.getElementById('kpi-avg-units');
        const kpiBestMonth = document.getElementById('kpi-best-month');
        const kpiWorstMonth = document.getElementById('kpi-worst-month');
        
        // --- 5. ATUALIZAÇÃO DO TIMESTAMP ---
        function updateCurrentTime() {
            const now = new Date();
            const optionsDate = { day: '2-digit', month: '2-digit', year: '2-digit' };
            const optionsTime = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
            const date = now.toLocaleDateString('pt-BR', optionsDate);
            const time = now.toLocaleTimeString('pt-BR', optionsTime);
            if (timestampElement) { timestampElement.textContent = `${date} ${time}`; }
        }
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);

        // --- 6. FUNÇÃO DE RENDERIZAÇÃO (Gráfico e Tabela) ---
        function renderDashboard(vendasData) {
            barsContainer.innerHTML = '';
            tableBody.innerHTML = '';
            
            if (vendasData.length === 0) {
                // Lida com o caso de não haver dados
                barsContainer.innerHTML = '<span style="color: var(--color-text-light); padding: 20px;">Nenhum dado de venda encontrado.</span>';
                tableBody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--color-text-light);">Nenhum dado encontrado.</td></tr>';
                return;
            }

            const maxValue = 500; // Valor máximo do eixo Y
            barsContainer.style.width = `${vendasData.length * 120}px`;

            let totalVendas = 0;
            let melhorMes = { mes: '--', valor: -Infinity };
            let piorMes = { mes: '--', valor: Infinity };

            vendasData.forEach(item => {
                const valor = Number(item.valor) || 0;
                totalVendas += valor;

                if (valor > melhorMes.valor) melhorMes = item;
                if (valor < piorMes.valor) piorMes = item;

                // --- Renderiza o Gráfico ---
                const barHeightPercentage = Math.min((valor / maxValue) * 100, 100);
                
                const barItem = document.createElement('div');
                let colorClass = 'blue'; // Padrão 'normal'
                if (item.status === 'green') colorClass = 'green';
                if (item.status === 'red') colorClass = 'red';
                
                barItem.className = `bar-item ${colorClass}`;
                barItem.style.height = `${barHeightPercentage}%`;
                barItem.innerHTML = `<span class="bar-label">${item.mes}</span>`;
                barsContainer.appendChild(barItem);

                // --- Renderiza a Tabela ---
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.mes}</td>
                    <td>${valor}</td>
                    <td><span class="status-badge status-${colorClass}">${item.statusTexto}</span></td>
                `;
                tableBody.appendChild(row);
            });

            // --- Atualiza KPIs ---
            const mediaMensal = totalVendas / vendasData.length;
            kpiTotalUnits.textContent = totalVendas;
            kpiAvgUnits.textContent = mediaMensal.toFixed(0);
            kpiBestMonth.textContent = `${melhorMes.mes} (${melhorMes.valor})`;
            kpiWorstMonth.textContent = `${piorMes.mes} (${piorMes.valor})`;
        }

        // --- 7. CARREGAMENTO INICIAL DO FIRESTORE ---
        async function loadAndRenderChart() {
            try {
                // Ordena pelo campo 'ordem'
                const q = query(vendasCollectionRef, orderBy("ordem", "asc"));
                const querySnapshot = await getDocs(q);
                
                let localVendasData = [];
                querySnapshot.forEach((doc) => {
                    localVendasData.push({ id: doc.id, ...doc.data() });
                });
                
                renderDashboard(localVendasData);
            } catch (error) {
                console.error("Erro ao carregar dados de vendas: ", error);
                // Se der erro de índice, o Firestore avisará no console
                // Por enquanto, tenta buscar sem ordenar
                if (error.code === 'failed-precondition') {
                    console.warn("Firestore: Índice não encontrado. Carregando sem ordenação.");
                    const fallbackSnapshot = await getDocs(vendasCollectionRef);
                    let localVendasData = [];
                    fallbackSnapshot.forEach((doc) => {
                        localVendasData.push({ id: doc.id, ...doc.data() });
                    });
                    renderDashboard(localVendasData);
                } else {
                    barsContainer.innerHTML = '<span style="color: red; padding: 20px;">Erro ao carregar gráfico.</span>';
                }
            }
        }

        // --- 8. INICIALIZAÇÃO ---
        loadAndRenderChart();
    </script>
</body>
</html>